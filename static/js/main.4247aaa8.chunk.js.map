{"version":3,"sources":["libs/MMDLoader.js","libs/BoneHelper.ts","components/ModelView.tsx","components/Status.tsx","contexts/ProjectContext.tsx","components/ActionButtons.tsx","components/MainView.tsx","components/BoneControl.tsx","components/FaceControl.tsx","components/PoseNetPreview.tsx","classes/ModelClass.ts","components/SelectLoadModelDIalog.tsx","components/ModelControl.tsx","components/ModelControllers.tsx","components/CameraControl.tsx","components/CameraControllers.tsx","App.tsx","reportWebVitals.ts","index.tsx"],"names":["MMDLoader","manager","Loader","call","this","loader","FileLoader","parser","fileArray","meshBuilder","MeshBuilder","animationBuilder","AnimationBuilder","prototype","Object","assign","create","constructor","setAnimationPath","animationPath","readFileAsDataURL","file","a","Promise","resolve","fileReader","FileReader","onload","e","result","readAsDataURL","result_base64","getFilesFromDir","dirHandle","path","name","entry","kind","getFile","loadFromDir","onLoad","onProgress","onError","builder","setCrossOrigin","crossOrigin","modelExtension","_extractExtension","toLowerCase","loadPMXFromFile","data","buildDir","loadPMDFromFile","loadFile","rootDirHandle","Error","load","url","resourcePath","LoaderUtils","extractUrlBase","build","loadAnimation","object","loadVMD","vmd","isCamera","buildCameraAnimation","loadWithAnimation","modelUrl","vmdUrl","scope","mesh","animation","loadPMD","_getParser","setMimeType","undefined","setPath","setResponseType","setRequestHeader","requestHeader","setWithCredentials","withCredentials","buffer","parsePmd","reader","readAsArrayBuffer","loadPMX","parsePmx","urls","Array","isArray","vmds","vmdNum","length","i","il","push","parseVmd","mergeVmds","loadVPD","isUnicode","text","parseVpd","loadVPDFromFile","onprogress","event","onerror","readAsText","index","lastIndexOf","slice","MMDParser","Parser","DEFAULT_TOON_TEXTURES","geometryBuilder","GeometryBuilder","materialBuilder","MaterialBuilder","initBones","bone","gbone","geometry","bones","Bone","position","fromArray","pos","quaternion","rotq","scl","scale","parent","add","updateMatrixWorld","textureLoader","TextureLoader","tgaLoader","CubicBezierInterpolation","parameterPositions","sampleValues","sampleSize","resultBuffer","params","Interpolant","interpolationParams","material","setResourcePath","SkinnedMesh","skeleton","Skeleton","bind","dir","console","log","setResourceDir","positions","uvs","normals","indices","groups","skinIndices","skinWeights","morphTargets","morphPositions","iks","grants","rigidBodies","constraints","offset","boneTypeTable","metadata","vertexCount","v","vertices","j","jl","normal","uv","faceCount","face","faces","materialCount","materials","count","rigidBodyCount","body","value","boneIndex","type","Math","max","boneCount","boneData","parentIndex","rigidBodyType","format","ikCount","param","target","ik","effector","iteration","maxAngle","links","link","enabled","indexOf","limitation","Vector3","angleLimitation","rotationMin","lowerLimitationAngle","rotationMax","upperLimitationAngle","tmp1","tmp2","grant","ratio","isLocal","affectRotation","affectPosition","transformationClass","sort","b","updateAttributes","attribute","morph","elementCount","element","elements","morphs","array","morphCount","Float32BufferAttribute","morph2","rigidBody","key","constraintCount","constraint","bodyA","rigidBodyIndex1","bodyB","rigidBodyIndex2","BufferGeometry","setAttribute","Uint16BufferAttribute","setIndex","addGroup","morphAttributes","morphTargetsRelative","userData","MMD","frames","modelName","englishModelName","comment","englishComment","computeBoundingSphere","resourceDir","textures","color","Color","diffuse","opacity","emissive","ambient","transparent","skinning","fog","blending","CustomBlending","blendSrc","SrcAlphaFactor","blendDst","OneMinusSrcAlphaFactor","blendSrcAlpha","blendDstAlpha","DstAlphaFactor","flag","side","DoubleSide","FrontSide","fileName","fileNames","split","map","_loadTexture","extension","envMap","combine","MultiplyOperation","AddOperation","toonFileName","toonIndex","toonTextures","gradientMap","isToonTexture","isDefaultToonTexture","_isDefaultToonTexture","outlineParameters","thickness","edgeFlag","alpha","visible","isDefaultToon","textureIndex","envTextureIndex","envFlag","toonFlag","edgeSize","edgeColor","_checkImageTransparency","multiplyScalar","MeshToonMaterial","checkAlphaMorph","_getTGALoader","TGALoader","test","filePath","fullPath","parseInt","match","warn","getHandler","texture","t","image","_getRotatedImage","magFilter","NearestFilter","minFilter","flipY","wrapS","RepeatWrapping","wrapT","readyCallbacks","canvas","document","createElement","context","getContext","width","height","clearRect","translate","rotate","PI","drawImage","getImageData","groupIndex","getAlphaByUv","x","round","y","imageData","createImageData","group","centerUV","detectImageTransparency","attributes","start","tracks","buildSkeletalAnimation","tracks2","buildMorphAnimation","AnimationClip","pushInterpolation","interpolation","motions","boneNameDictionary","motionCount","motion","boneName","frameNum","times","rotations","pInterpolations","rInterpolations","basePosition","getBoneByName","toArray","time","rotation","targetName","_createTrack","VectorKeyframeTrack","QuaternionKeyframeTrack","morphTargetDictionary","morphName","values","weight","NumberKeyframeTrack","pushVector3","vec","z","cameras","q","centers","quaternions","fovs","cInterpolations","qInterpolations","fInterpolations","Quaternion","euler","Euler","center","rot","distance","fov","set","setFromEuler","applyQuaternion","w","node","typedKeyframeTrack","interpolations","stride","interpolateStride","aheadIndex","endIndex","track","createInterpolant","getValueSize","Float32Array","interpolate_","i1","t0","t1","valueSize","offset1","offset0","weight1","x1","x2","y1","y2","_calculate","slerpFlat","sst3","stt3","ttt","c","s","math","ft","abs","planeBones","BoneHelper","matrix","copy","matrixWorld","invert","SphereGeometry","targetSphereMaterial","MeshBasicMaterial","depthTest","depthWrite","m","Mesh","bone_id","getPosition","matrixAutoUpdate","force","children","matrixWorldInv","setFromMatrixPosition","applyMatrix4","Object3D","ModelView","props","useRef","transform","ray","Raycaster","useThree","scene","mouse","camera","useState","helper","setHelper","selectObject","setSelectObject","handleModelClick","useCallback","oldObject","useFrame","current","activeModelIndex","setFromCamera","intersects","intersectObjects","bone_name","setLabelText","setIsShowLabel","useLayoutEffect","controls","callback","orbit","attach","isShowBoneSelect","controlMode","setMode","detach","addEventListener","removeEventListener","TransformControls","ref","onClick","modelClass","dispose","Status","UpperLeft","style","top","left","base","css","styled","div","project","setDirHandle","models","setModels","setactiveModelIndex","editMode","setEditMode","setFov","ProjectContext","createContext","useStyles","makeStyles","theme","createStyles","zIndex","right","ActionBUttons","panStart","Vector2","panEnd","panDelta","classes","refZoom","refTransform","panLeft","objectMatrix","setFromMatrixColumn","panUp","Fab","size","className","onMouseDown","requestPointerLock","onMouseUp","window","exitPointerLock","onMouseMove","pointerLockElement","translateZ","movementY","clientX","clientY","orbitControl","domElement","panSpeed","movementX","subVectors","sub","targetDistance","tan","panOffset","clientWidth","clientHeight","Camera","setDefaultCamera","useEffect","updateProjectionMatrix","MainView","labelP","setLabelP","labelText","isShowLabel","projectContext","useContext","backgroundColor","colorManagement","Stats","showPanel","intensity","castShadow","fallback","model","OrbitControls","Button","BoneControl","textAlign","padding","fontSize","margin","ButtonGroup","fullWidth","aria-label","setIsShowBoneSelect","setControlMode","formControl","spacing","minWidth","selectEmpty","marginTop","MorphControl","selectValue","setSelectValue","FormControl","variant","InputLabel","id","label","Select","labelId","onChange","n","handleChange","morphType","Number","native","Slider","morphSliders","newValue","aria-labelledby","step","min","FaceControl","setMorphs","setMorphSliders","morphTargetInfluences","morphs_array","panel","morphs_array_num","newMprphSliders","error","root","maxWidth","palette","background","paper","maxHeight","PoseNetPreview","canvasRef","content","onClose","valueProp","open","other","React","setValue","radioGroupRef","ctx","d","imageWidth","imageHeight","setTransform","Dialog","disableBackdropClick","disableEscapeKeyDown","onEntering","focus","DialogTitle","DialogContent","dividers","DialogActions","autoFocus","ModelClass","SelectLoadModelDialog","progressOpen","setProgressOpen","handleClose","setOpen","Backdrop","CircularProgress","keepMounted","List","component","role","ListItem","button","divider","newModels","newActiveId","alert","handleListItemClick","ListItemText","primary","ModelControl","selectLoadModelDialogOpen","setSelectLoadModelDialogOpen","selectLoadModelDialogValue","setSelectLoadModelDialogValue","files","extensionIndex","concat","showDirectoryPicker","filter","ModelControllers","Grid","item","xs","border","input","CameraControl","Typography","gutterBottom","container","alignItems","valueLabelDisplay","Input","onBlur","inputProps","CameraControllers","App","anchorEl","setAnchorEl","menuName","setMenuName","localStorage","getItem","darkMode","setDarkMode","handleMenu","currentTarget","createMuiTheme","openPoseFile","pickerOpts","types","description","accept","excludeAcceptAllOption","multiple","showOpenFilePicker","fileHandle","MMDAnimationHelper","vpd","pose","progress","openAbout","ThemeProvider","Provider","CssBaseline","AppBar","Toolbar","Box","display","flexGrow","p","aria-controls","aria-haspopup","Menu","anchorOrigin","vertical","horizontal","transformOrigin","MenuItem","IconButton","setItem","reportWebVitals","onPerfEntry","Function","then","getCLS","getFID","getFCP","getLCP","getTTFB","ReactDOM","render","StrictMode","getElementById"],"mappings":"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","file":"static/js/main.4247aaa8.chunk.js","sourcesContent":["import {\r\n\tAddOperation,\r\n\tAnimationClip,\r\n\tBone,\r\n\tBufferGeometry,\r\n\tColor,\r\n\tCustomBlending,\r\n\tDoubleSide,\r\n\tDstAlphaFactor,\r\n\tEuler,\r\n\tFileLoader,\r\n\tFloat32BufferAttribute,\r\n\tFrontSide,\r\n\tInterpolant,\r\n\tLoader,\r\n\tLoaderUtils,\r\n\tMeshToonMaterial,\r\n\tMultiplyOperation,\r\n\tNearestFilter,\r\n\tNumberKeyframeTrack,\r\n\tOneMinusSrcAlphaFactor,\r\n\tQuaternion,\r\n\tQuaternionKeyframeTrack,\r\n\tRepeatWrapping,\r\n\tSkeleton,\r\n\tSkinnedMesh,\r\n\tSrcAlphaFactor,\r\n\tTextureLoader,\r\n\tUint16BufferAttribute,\r\n\tVector3,\r\n\tVectorKeyframeTrack\r\n} from \"three\";\r\nimport { TGALoader } from \"../../node_modules/three/examples/jsm/loaders/TGALoader.js\";\r\nimport { MMDParser } from \"../../node_modules/three/examples/jsm/libs/mmdparser.module\";\r\n\r\n/**\r\n * Dependencies\r\n *  - mmd-parser https://github.com/takahirox/mmd-parser\r\n *  - TGALoader\r\n *  - OutlineEffect\r\n *\r\n * MMDLoader creates Three.js Objects from MMD resources as\r\n * PMD, PMX, VMD, and VPD files.\r\n *\r\n * PMD/PMX is a model data format, VMD is a motion data format\r\n * VPD is a posing data format used in MMD(Miku Miku Dance).\r\n *\r\n * MMD official site\r\n *  - https://sites.google.com/view/evpvp/\r\n *\r\n * PMD, VMD format (in Japanese)\r\n *  - http://blog.goo.ne.jp/torisu_tetosuki/e/209ad341d3ece2b1b4df24abf619d6e4\r\n *\r\n * PMX format\r\n *  - https://gist.github.com/felixjones/f8a06bd48f9da9a4539f\r\n *\r\n * TODO\r\n *  - light motion in vmd support.\r\n *  - SDEF support.\r\n *  - uv/material/bone morphing support.\r\n *  - more precise grant skinning support.\r\n *  - shadow support.\r\n */\r\n\r\nvar MMDLoader = ( function () {\r\n\r\n\t/**\r\n\t * @param {THREE.LoadingManager} manager\r\n\t */\r\n\tfunction MMDLoader( manager ) {\r\n\r\n\t\tLoader.call( this, manager );\r\n\r\n\t\tthis.loader = new FileLoader( this.manager );\r\n\r\n\t\tthis.parser = null; // lazy generation\r\n\t\tthis.fileArray = [];\r\n\t\tthis.meshBuilder = new MeshBuilder( this.manager );\r\n\t\tthis.animationBuilder = new AnimationBuilder();\r\n\r\n\t}\r\n\r\n\tMMDLoader.prototype = Object.assign( Object.create( Loader.prototype ), {\r\n\r\n\t\tconstructor: MMDLoader,\r\n\r\n\t\t/**\r\n\t\t * @param {string} animationPath\r\n\t\t * @return {MMDLoader}\r\n\t\t */\r\n\t\tsetAnimationPath: function ( animationPath ) {\r\n\r\n\t\t\tthis.animationPath = animationPath;\r\n\t\t\treturn this;\r\n\r\n\t\t},\r\n\r\n\t\t// Load MMD assets as Three.js Object\r\n\t\treadFileAsDataURL: async function(file) {\r\n\t\t\tlet result_base64 = await new Promise((resolve) => {\r\n\t\t\t\tlet fileReader = new FileReader();\r\n\t\t\t\tfileReader.onload = (e) => resolve(fileReader.result);\r\n\t\t\t\tfileReader.readAsDataURL(file);\r\n\t\t\t});\r\n\t\t\treturn result_base64;\r\n\t\t},\r\n\t\tgetFilesFromDir: async function(dirHandle,path) {\r\n\t\t\tfor await(var [name, entry] of dirHandle) {\r\n\t\t\t\tif (entry.kind === 'file') {\r\n\t\t\t\t\tvar file = await entry.getFile();\r\n\t\t\t\t\tthis.fileArray[path + name] = await this.readFileAsDataURL(file);\r\n\t\t\t\t} else if (entry.kind === 'directory') {\r\n\t\t\t\t\tawait this.getFilesFromDir(entry, entry.name + '\\\\');\r\n\t\t\t\t}\r\n\t\t\t}\r\n\t\t},\r\n\t\tloadFromDir: async function(dirHandle, onLoad, onProgress, onError ){\r\n\t\t\tvar builder = this.meshBuilder.setCrossOrigin( this.crossOrigin );\r\n\t\t\tawait this.getFilesFromDir(dirHandle,\"\");\r\n\t\t\tfor await(var [name, entry] of dirHandle) {\r\n\t\t\t\tvar modelExtension = this._extractExtension(name).toLowerCase();\r\n\t\t\t\tif(modelExtension === 'pmx') {\r\n\t\t\t\t\tconst file = await entry.getFile();\r\n\t\t\t\t\tthis.loadPMXFromFile(file,(data) => {\r\n\t\t\t\t\t\tonLoad(builder.buildDir( data, this.fileArray, null, null));\r\n\t\t\t\t\t});\r\n\t\t\t\t} else if(modelExtension === 'pmd') {\r\n\t\t\t\t\tconst file = await entry.getFile();\r\n\t\t\t\t\tthis.loadPMDFromFile(file,(data) => {\r\n\t\t\t\t\t\tonLoad(builder.buildDir( data, this.fileArray, null, null));\r\n\t\t\t\t\t});\r\n\t\t\t\t}\r\n\t\t\t}\r\n\t\t\t\r\n\t\t},\r\n\t\tloadFile: async function(file,rootDirHandle, onLoad, onProgress, onError ){\r\n\t\t\tthis.fileArray = [];\r\n\t\t\tawait this.getFilesFromDir(rootDirHandle,\"\");\r\n\t\t\tvar modelExtension = this._extractExtension(file.name).toLowerCase();\r\n\t\t\tif ( modelExtension !== 'pmd' && modelExtension !== 'pmx' ) {\r\n\t\t\t\tif ( onError ) onError( new Error( 'THREE.MMDLoader: Unknown model file extension .' + modelExtension + '.' ) );\r\n\t\t\t\treturn;\r\n\t\t\t}\r\n\t\t\tvar builder = this.meshBuilder.setCrossOrigin( this.crossOrigin );\r\n\t\t\tthis[ modelExtension === 'pmd' ? 'loadPMDFromFile' : 'loadPMXFromFile' ](file,async (data) => {\r\n\t\t\t\tonLoad(builder.buildDir( data, this.fileArray, null, null), onProgress, onError);\r\n\t\t\t}, onProgress, onError);\r\n\t\t},\r\n\r\n\t\t/**\r\n\t\t * Loads Model file (.pmd or .pmx) as a SkinnedMesh.\r\n\t\t *\r\n\t\t * @param {string} url - url to Model(.pmd or .pmx) file\r\n\t\t * @param {function} onLoad\r\n\t\t * @param {function} onProgress\r\n\t\t * @param {function} onError\r\n\t\t */\r\n\t\tload: function ( url, onLoad, onProgress, onError ) {\r\n\t\t\tvar builder = this.meshBuilder.setCrossOrigin( this.crossOrigin );\r\n\r\n\t\t\t// resource path\r\n\r\n\t\t\tvar resourcePath;\r\n\r\n\t\t\tif ( this.resourcePath !== '' ) {\r\n\r\n\t\t\t\tresourcePath = this.resourcePath;\r\n\r\n\t\t\t} else if ( this.path !== '' ) {\r\n\r\n\t\t\t\tresourcePath = this.path;\r\n\r\n\t\t\t} else {\r\n\r\n\t\t\t\tresourcePath = LoaderUtils.extractUrlBase( url );\r\n\r\n\t\t\t}\r\n\r\n\t\t\tvar modelExtension = this._extractExtension( url ).toLowerCase();\r\n\r\n\t\t\t// Should I detect by seeing header?\r\n\t\t\tif ( modelExtension !== 'pmd' && modelExtension !== 'pmx' ) {\r\n\r\n\t\t\t\tif ( onError ) onError( new Error( 'THREE.MMDLoader: Unknown model file extension .' + modelExtension + '.' ) );\r\n\r\n\t\t\t\treturn;\r\n\r\n\t\t\t}\r\n\r\n\t\t\tthis[ modelExtension === 'pmd' ? 'loadPMD' : 'loadPMX' ]( url, function ( data ) {\r\n\r\n\t\t\t\tonLoad(\tbuilder.build( data, resourcePath, onProgress, onError )\t);\r\n\r\n\t\t\t}, onProgress, onError );\r\n\r\n\t\t},\r\n\r\n\t\t/**\r\n\t\t * Loads Motion file(s) (.vmd) as a AnimationClip.\r\n\t\t * If two or more files are specified, they'll be merged.\r\n\t\t *\r\n\t\t * @param {string|Array<string>} url - url(s) to animation(.vmd) file(s)\r\n\t\t * @param {SkinnedMesh|THREE.Camera} object - tracks will be fitting to this object\r\n\t\t * @param {function} onLoad\r\n\t\t * @param {function} onProgress\r\n\t\t * @param {function} onError\r\n\t\t */\r\n\t\tloadAnimation: function ( url, object, onLoad, onProgress, onError ) {\r\n\r\n\t\t\tvar builder = this.animationBuilder;\r\n\r\n\t\t\tthis.loadVMD( url, function ( vmd ) {\r\n\r\n\t\t\t\tonLoad( object.isCamera\r\n\t\t\t\t\t? builder.buildCameraAnimation( vmd )\r\n\t\t\t\t\t: builder.build( vmd, object ) );\r\n\r\n\t\t\t}, onProgress, onError );\r\n\r\n\t\t},\r\n\r\n\t\t/**\r\n\t\t * Loads mode file and motion file(s) as an object containing\r\n\t\t * a SkinnedMesh and a AnimationClip.\r\n\t\t * Tracks of AnimationClip are fitting to the model.\r\n\t\t *\r\n\t\t * @param {string} modelUrl - url to Model(.pmd or .pmx) file\r\n\t\t * @param {string|Array{string}} vmdUrl - url(s) to animation(.vmd) file\r\n\t\t * @param {function} onLoad\r\n\t\t * @param {function} onProgress\r\n\t\t * @param {function} onError\r\n\t\t */\r\n\t\tloadWithAnimation: function ( modelUrl, vmdUrl, onLoad, onProgress, onError ) {\r\n\r\n\t\t\tvar scope = this;\r\n\r\n\t\t\tthis.load( modelUrl, function ( mesh ) {\r\n\r\n\t\t\t\tscope.loadAnimation( vmdUrl, mesh, function ( animation ) {\r\n\r\n\t\t\t\t\tonLoad( {\r\n\t\t\t\t\t\tmesh: mesh,\r\n\t\t\t\t\t\tanimation: animation\r\n\t\t\t\t\t} );\r\n\r\n\t\t\t\t}, onProgress, onError );\r\n\r\n\t\t\t}, onProgress, onError );\r\n\r\n\t\t},\r\n\r\n\t\t// Load MMD assets as Object data parsed by MMDParser\r\n\r\n\t\t/**\r\n\t\t * Loads .pmd file as an Object.\r\n\t\t *\r\n\t\t * @param {string} url - url to .pmd file\r\n\t\t * @param {function} onLoad\r\n\t\t * @param {function} onProgress\r\n\t\t * @param {function} onError\r\n\t\t */\r\n\t\tloadPMD: function ( url, onLoad, onProgress, onError ) {\r\n\r\n\t\t\tvar parser = this._getParser();\r\n\r\n\t\t\tthis.loader\r\n\t\t\t\t.setMimeType( undefined )\r\n\t\t\t\t.setPath( this.path )\r\n\t\t\t\t.setResponseType( 'arraybuffer' )\r\n\t\t\t\t.setRequestHeader( this.requestHeader )\r\n\t\t\t\t.setWithCredentials( this.withCredentials )\r\n\t\t\t\t.load( url, function ( buffer ) {\r\n\r\n\t\t\t\t\tonLoad( parser.parsePmd( buffer, true ) );\r\n\r\n\t\t\t\t}, onProgress, onError );\r\n\r\n\t\t},\r\n\r\n\t\tloadPMDFromFile: function ( file, onLoad, onProgress, onError ) {\r\n\t\t\tvar parser = this._getParser();\r\n\t\t\tlet reader = new FileReader();\r\n\t\t\treader.onload = function () {\r\n\t\t\t\tonLoad( parser.parsePmd( reader.result, true ) );\r\n\t\t\t}\r\n\t\t\treader.readAsArrayBuffer(file);\r\n\t\t},\r\n\r\n\t\t/**\r\n\t\t * Loads .pmx file as an Object.\r\n\t\t *\r\n\t\t * @param {string} url - url to .pmx file\r\n\t\t * @param {function} onLoad\r\n\t\t * @param {function} onProgress\r\n\t\t * @param {function} onError\r\n\t\t */\r\n\t\tloadPMX: function ( url, onLoad, onProgress, onError ) {\r\n\r\n\t\t\tvar parser = this._getParser();\r\n\r\n\t\t\tthis.loader\r\n\t\t\t\t.setMimeType( undefined )\r\n\t\t\t\t.setPath( this.path )\r\n\t\t\t\t.setResponseType( 'arraybuffer' )\r\n\t\t\t\t.setRequestHeader( this.requestHeader )\r\n\t\t\t\t.setWithCredentials( this.withCredentials )\r\n\t\t\t\t.load( url, function ( buffer ) {\r\n\r\n\t\t\t\t\tonLoad( parser.parsePmx( buffer, true ) );\r\n\r\n\t\t\t\t}, onProgress, onError );\r\n\r\n\t\t},\r\n\t\tloadPMXFromFile: function ( file, onLoad, onProgress, onError ) {\r\n\t\t\tvar parser = this._getParser();\r\n\t\t\tlet reader = new FileReader();\r\n\t\t\treader.onload = function () {\r\n\t\t\t\tonLoad( parser.parsePmx( reader.result, true ) );\r\n\t\t\t}\r\n\t\t\treader.readAsArrayBuffer(file);\r\n\t\t},\r\n\r\n\t\t/**\r\n\t\t * Loads .vmd file as an Object. If two or more files are specified\r\n\t\t * they'll be merged.\r\n\t\t *\r\n\t\t * @param {string|Array<string>} url - url(s) to .vmd file(s)\r\n\t\t * @param {function} onLoad\r\n\t\t * @param {function} onProgress\r\n\t\t * @param {function} onError\r\n\t\t */\r\n\t\tloadVMD: function ( url, onLoad, onProgress, onError ) {\r\n\r\n\t\t\tvar urls = Array.isArray( url ) ? url : [ url ];\r\n\r\n\t\t\tvar vmds = [];\r\n\t\t\tvar vmdNum = urls.length;\r\n\r\n\t\t\tvar parser = this._getParser();\r\n\r\n\t\t\tthis.loader\r\n\t\t\t\t.setMimeType( undefined )\r\n\t\t\t\t.setPath( this.animationPath )\r\n\t\t\t\t.setResponseType( 'arraybuffer' )\r\n\t\t\t\t.setRequestHeader( this.requestHeader )\r\n\t\t\t\t.setWithCredentials( this.withCredentials );\r\n\r\n\t\t\tfor ( var i = 0, il = urls.length; i < il; i ++ ) {\r\n\r\n\t\t\t\tthis.loader.load( urls[ i ], function ( buffer ) {\r\n\r\n\t\t\t\t\tvmds.push( parser.parseVmd( buffer, true ) );\r\n\r\n\t\t\t\t\tif ( vmds.length === vmdNum ) onLoad( parser.mergeVmds( vmds ) );\r\n\r\n\t\t\t\t}, onProgress, onError );\r\n\r\n\t\t\t}\r\n\r\n\t\t},\r\n\r\n\t\t/**\r\n\t\t * Loads .vpd file as an Object.\r\n\t\t *\r\n\t\t * @param {string} url - url to .vpd file\r\n\t\t * @param {boolean} isUnicode\r\n\t\t * @param {function} onLoad\r\n\t\t * @param {function} onProgress\r\n\t\t * @param {function} onError\r\n\t\t */\r\n\t\tloadVPD: function ( url, isUnicode, onLoad, onProgress, onError ) {\r\n\r\n\t\t\tvar parser = this._getParser();\r\n\r\n\t\t\tthis.loader\r\n\t\t\t\t.setMimeType( isUnicode ? undefined : 'text/plain; charset=shift_jis' )\r\n\t\t\t\t.setPath( this.animationPath )\r\n\t\t\t\t.setResponseType( 'text' )\r\n\t\t\t\t.setRequestHeader( this.requestHeader )\r\n\t\t\t\t.setWithCredentials( this.withCredentials )\r\n\t\t\t\t.load( url, function ( text ) {\r\n\r\n\t\t\t\t\tonLoad( parser.parseVpd( text, true ) );\r\n\r\n\t\t\t\t}, onProgress, onError );\r\n\r\n\t\t},\r\n\r\n\t\tloadVPDFromFile: function (file, onLoad, onProgress, onError) {\r\n\t\t\tvar parser = this._getParser();\r\n\t\t\tlet reader = new FileReader();\r\n\t\t\treader.onload = function () {\r\n\t\t\t\tonLoad( parser.parseVpd( reader.result, true ) );\r\n\t\t\t}\r\n\t\t\treader.onprogress = function (event) {\r\n\t\t\t\tonProgress(event);\r\n\t\t\t}\r\n\t\t\treader.onerror = function (event) {\r\n\t\t\t\tonError(event);\r\n\t\t\t} \r\n\t\t\treader.readAsText(file, 'Shift_JIS');\r\n\t\t},\r\n\r\n\t\t// private methods\r\n\r\n\t\t_extractExtension: function ( url ) {\r\n\r\n\t\t\tvar index = url.lastIndexOf( '.' );\r\n\t\t\treturn index < 0 ? '' : url.slice( index + 1 );\r\n\r\n\t\t},\r\n\r\n\t\t_getParser: function () {\r\n\r\n\t\t\tif ( this.parser === null ) {\r\n\r\n\t\t\t\tif ( typeof MMDParser === 'undefined' ) {\r\n\r\n\t\t\t\t\tthrow new Error( 'THREE.MMDLoader: Import MMDParser https://github.com/takahirox/mmd-parser' );\r\n\r\n\t\t\t\t}\r\n\r\n\t\t\t\tthis.parser = new MMDParser.Parser(); // eslint-disable-line no-undef\r\n\r\n\t\t\t}\r\n\r\n\t\t\treturn this.parser;\r\n\r\n\t\t}\r\n\r\n\t} );\r\n\r\n\t// Utilities\r\n\r\n\t/*\r\n\t * base64 encoded defalut toon textures toon00.bmp - toon10.bmp.\r\n\t * We don't need to request external toon image files.\r\n\t * This idea is from http://www20.atpages.jp/katwat/three.js_r58/examples/mytest37/mmd.three.js\r\n\t */\r\n\tvar DEFAULT_TOON_TEXTURES = [\r\n\t\t'data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAACAAAAAgCAYAAABzenr0AAAAL0lEQVRYR+3QQREAAAzCsOFfNJPBJ1XQS9r2hsUAAQIECBAgQIAAAQIECBAgsBZ4MUx/ofm2I/kAAAAASUVORK5CYII=',\r\n\t\t'data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAACAAAAAgCAYAAABzenr0AAAAN0lEQVRYR+3WQREAMBACsZ5/bWiiMvgEBTt5cW37hjsBBAgQIECAwFwgyfYPCCBAgAABAgTWAh8aBHZBl14e8wAAAABJRU5ErkJggg==',\r\n\t\t'data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAACAAAAAgCAYAAABzenr0AAAAOUlEQVRYR+3WMREAMAwDsYY/yoDI7MLwIiP40+RJklfcCCBAgAABAgTqArfb/QMCCBAgQIAAgbbAB3z/e0F3js2cAAAAAElFTkSuQmCC',\r\n\t\t'data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAACAAAAAgCAYAAABzenr0AAAAN0lEQVRYR+3WQREAMBACsZ5/B5ilMvgEBTt5cW37hjsBBAgQIECAwFwgyfYPCCBAgAABAgTWAh81dWyx0gFwKAAAAABJRU5ErkJggg==',\r\n\t\t'data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAACAAAAAgCAYAAABzenr0AAAAOklEQVRYR+3WoREAMAwDsWb/UQtCy9wxTOQJ/oQ8SXKKGwEECBAgQIBAXeDt7f4BAQQIECBAgEBb4AOz8Hzx7WLY4wAAAABJRU5ErkJggg==',\r\n\t\t'data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAACAAAAAgCAYAAABzenr0AAABPUlEQVRYR+1XwW7CMAy1+f9fZOMysSEOEweEOPRNdm3HbdOyIhAcklPrOs/PLy9RygBALxzcCDQFmgJNgaZAU6Ap0BR4PwX8gsRMVLssMRH5HcpzJEaWL7EVg9F1IHRlyqQohgVr4FGUlUcMJSjcUlDw0zvjeun70cLWmneoyf7NgBTQSniBTQQSuJAZsOnnaczjIMb5hCiuHKxokCrJfVnrctyZL0PkJAJe1HMil4nxeyi3Ypfn1kX51jpPvo/JeCNC4PhVdHdJw2XjBR8brF8PEIhNVn12AgP7uHsTBguBn53MUZCqv7Lp07Pn5k1Ro+uWmUNn7D+M57rtk7aG0Vo73xyF/fbFf0bPJjDXngnGocDTdFhygZjwUQrMNrDcmZlQT50VJ/g/UwNyHpu778+yW+/ksOz/BFo54P4AsUXMfRq7XWsAAAAASUVORK5CYII=',\r\n\t\t'data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAACAAAAAgCAYAAABzenr0AAACMElEQVRYR+2Xv4pTQRTGf2dubhLdICiii2KnYKHVolhauKWPoGAnNr6BD6CvIVaihYuI2i1ia0BY0MZGRHQXjZj/mSPnnskfNWiWZUlzJ5k7M2cm833nO5Mziej2DWWJRUoCpQKlAntSQCqgw39/iUWAGmh37jrRnVsKlgpiqmkoGVABA7E57fvY+pJDdgKqF6HzFCSADkDq+F6AHABtQ+UMVE5D7zXod7fFNhTEckTbj5XQgHzNN+5tQvc5NG7C6BNkp6D3EmpXHDR+dQAjFLchW3VS9rlw3JBh+B7ys5Cf9z0GW1C/7P32AyBAOAz1q4jGliIH3YPuBnSfQX4OGreTIgEYQb/pBDtPnEQ4CivXYPAWBk13oHrB54yA9QuSn2H4AcKRpEILDt0BUzj+RLR1V5EqjD66NPRBVpLcQwjHoHYJOhsQv6U4mnzmrIXJCFr4LDwm/xBUoboG9XX4cc9VKdYoSA2yk5NQLJaKDUjTBoveG3Z2TElTxwjNK4M3LEZgUdDdruvcXzKBpStgp2NPiWi3ks9ZXxIoFVi+AvHLdc9TqtjL3/aYjpPlrzOcEnK62Szhimdd7xX232zFDTgtxezOu3WNMRLjiKgjtOhHVMd1loynVHvOgjuIIJMaELEqhJAV/RCSLbWTcfPFakFgFlALTRRvx+ok6Hlp/Q+v3fmx90bMyUzaEAhmM3KvHlXTL5DxnbGf/1M8RNNACLL5MNtPxP/mypJAqcDSFfgFhpYqWUzhTEAAAAAASUVORK5CYII=',\r\n\t\t'data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAACAAAAAgCAYAAABzenr0AAAAL0lEQVRYR+3QQREAAAzCsOFfNJPBJ1XQS9r2hsUAAQIECBAgQIAAAQIECBAgsBZ4MUx/ofm2I/kAAAAASUVORK5CYII=',\r\n\t\t'data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAACAAAAAgCAYAAABzenr0AAAAL0lEQVRYR+3QQREAAAzCsOFfNJPBJ1XQS9r2hsUAAQIECBAgQIAAAQIECBAgsBZ4MUx/ofm2I/kAAAAASUVORK5CYII=',\r\n\t\t'data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAACAAAAAgCAYAAABzenr0AAAAL0lEQVRYR+3QQREAAAzCsOFfNJPBJ1XQS9r2hsUAAQIECBAgQIAAAQIECBAgsBZ4MUx/ofm2I/kAAAAASUVORK5CYII=',\r\n\t\t'data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAACAAAAAgCAYAAABzenr0AAAAL0lEQVRYR+3QQREAAAzCsOFfNJPBJ1XQS9r2hsUAAQIECBAgQIAAAQIECBAgsBZ4MUx/ofm2I/kAAAAASUVORK5CYII='\r\n\t];\r\n\r\n\t// Builders. They build Three.js object from Object data parsed by MMDParser.\r\n\r\n\t/**\r\n\t * @param {THREE.LoadingManager} manager\r\n\t */\r\n\tfunction MeshBuilder( manager ) {\r\n\r\n\t\tthis.geometryBuilder = new GeometryBuilder();\r\n\t\tthis.materialBuilder = new MaterialBuilder( manager );\r\n\r\n\t}\r\n\r\n\tMeshBuilder.prototype = {\r\n\r\n\t\tconstructor: MeshBuilder,\r\n\r\n\t\tcrossOrigin: 'anonymous',\r\n\r\n\t\t/**\r\n\t\t * @param {string} crossOrigin\r\n\t\t * @return {MeshBuilder}\r\n\t\t */\r\n\t\tsetCrossOrigin: function ( crossOrigin ) {\r\n\r\n\t\t\tthis.crossOrigin = crossOrigin;\r\n\t\t\treturn this;\r\n\r\n\t\t},\r\n\r\n\t\t/**\r\n\t\t * @param {Object} data - parsed PMD/PMX data\r\n\t\t * @param {string} resourcePath\r\n\t\t * @param {function} onProgress\r\n\t\t * @param {function} onError\r\n\t\t * @return {SkinnedMesh}\r\n\t\t */\r\n\t\tbuild: function ( data, resourcePath, onProgress, onError ) {\r\n\r\n\t\t\tvar geometry = this.geometryBuilder.build( data );\r\n\t\t\tvar material = this.materialBuilder\r\n\t\t\t\t.setCrossOrigin( this.crossOrigin )\r\n\t\t\t\t.setResourcePath( resourcePath )\r\n\t\t\t\t.build( data, geometry, onProgress, onError );\r\n\r\n\t\t\tvar mesh = new SkinnedMesh( geometry, material );\r\n\r\n\t\t\tvar skeleton = new Skeleton( initBones( mesh ) );\r\n\t\t\tmesh.bind( skeleton );\r\n\r\n\t\t\t// console.log( mesh ); // for console debug\r\n\r\n\t\t\treturn mesh;\r\n\r\n\t\t},\r\n\r\n\t\tbuildDir: function (data, dir, onProgress, onError ) {\r\n\t\t\tvar geometry = this.geometryBuilder.build( data );\r\n\t\t\tconsole.log(geometry);\r\n\t\t\tvar material = this.materialBuilder\r\n\t\t\t\t.setCrossOrigin( this.crossOrigin )\r\n\t\t\t\t.setResourceDir( dir )\r\n\t\t\t\t.build( data, geometry, onProgress, onError );\r\n\t\t\tvar mesh = new SkinnedMesh( geometry, material );\r\n\r\n\t\t\tvar skeleton = new Skeleton( initBones( mesh ) );\r\n\t\t\tmesh.bind( skeleton );\r\n\t\t\treturn mesh;\r\n\t\t}\r\n\r\n\t};\r\n\r\n\t// TODO: Try to remove this function\r\n\r\n\tfunction initBones( mesh ) {\r\n\r\n\t\tvar geometry = mesh.geometry;\r\n\r\n\t\tvar bones = [], bone, gbone;\r\n\t\tvar i, il;\r\n\r\n\t\tif ( geometry && geometry.bones !== undefined ) {\r\n\r\n\t\t\t// first, create array of 'Bone' objects from geometry data\r\n\r\n\t\t\tfor ( i = 0, il = geometry.bones.length; i < il; i ++ ) {\r\n\r\n\t\t\t\tgbone = geometry.bones[ i ];\r\n\r\n\t\t\t\t// create new 'Bone' object\r\n\r\n\t\t\t\tbone = new Bone();\r\n\t\t\t\tbones.push( bone );\r\n\r\n\t\t\t\t// apply values\r\n\r\n\t\t\t\tbone.name = gbone.name;\r\n\t\t\t\tbone.position.fromArray( gbone.pos );\r\n\t\t\t\tbone.quaternion.fromArray( gbone.rotq );\r\n\t\t\t\tif ( gbone.scl !== undefined ) bone.scale.fromArray( gbone.scl );\r\n\r\n\t\t\t}\r\n\r\n\t\t\t// second, create bone hierarchy\r\n\r\n\t\t\tfor ( i = 0, il = geometry.bones.length; i < il; i ++ ) {\r\n\r\n\t\t\t\tgbone = geometry.bones[ i ];\r\n\r\n\t\t\t\tif ( ( gbone.parent !== - 1 ) && ( gbone.parent !== null ) && ( bones[ gbone.parent ] !== undefined ) ) {\r\n\r\n\t\t\t\t\t// subsequent bones in the hierarchy\r\n\r\n\t\t\t\t\tbones[ gbone.parent ].add( bones[ i ] );\r\n\r\n\t\t\t\t} else {\r\n\r\n\t\t\t\t\t// topmost bone, immediate child of the skinned mesh\r\n\r\n\t\t\t\t\tmesh.add( bones[ i ] );\r\n\r\n\t\t\t\t}\r\n\r\n\t\t\t}\r\n\r\n\t\t}\r\n\r\n\t\t// now the bones are part of the scene graph and children of the skinned mesh.\r\n\t\t// let's update the corresponding matrices\r\n\r\n\t\tmesh.updateMatrixWorld( true );\r\n\r\n\t\treturn bones;\r\n\r\n\t}\r\n\r\n\t//\r\n\r\n\tfunction GeometryBuilder() {\r\n\r\n\t}\r\n\r\n\tGeometryBuilder.prototype = {\r\n\r\n\t\tconstructor: GeometryBuilder,\r\n\r\n\t\t/**\r\n\t\t * @param {Object} data - parsed PMD/PMX data\r\n\t\t * @return {BufferGeometry}\r\n\t\t */\r\n\t\tbuild: function ( data ) {\r\n\r\n\t\t\t// for geometry\r\n\t\t\tvar positions = [];\r\n\t\t\tvar uvs = [];\r\n\t\t\tvar normals = [];\r\n\r\n\t\t\tvar indices = [];\r\n\r\n\t\t\tvar groups = [];\r\n\r\n\t\t\tvar bones = [];\r\n\t\t\tvar skinIndices = [];\r\n\t\t\tvar skinWeights = [];\r\n\r\n\t\t\tvar morphTargets = [];\r\n\t\t\tvar morphPositions = [];\r\n\r\n\t\t\tvar iks = [];\r\n\t\t\tvar grants = [];\r\n\r\n\t\t\tvar rigidBodies = [];\r\n\t\t\tvar constraints = [];\r\n\r\n\t\t\t// for work\r\n\t\t\tvar offset = 0;\r\n\t\t\tvar boneTypeTable = {};\r\n\r\n\t\t\t// positions, normals, uvs, skinIndices, skinWeights\r\n\r\n\t\t\tfor ( var i = 0; i < data.metadata.vertexCount; i ++ ) {\r\n\r\n\t\t\t\tvar v = data.vertices[ i ];\r\n\r\n\t\t\t\tfor ( var j = 0, jl = v.position.length; j < jl; j ++ ) {\r\n\r\n\t\t\t\t\tpositions.push( v.position[ j ] );\r\n\r\n\t\t\t\t}\r\n\r\n\t\t\t\tfor ( var j = 0, jl = v.normal.length; j < jl; j ++ ) {\r\n\r\n\t\t\t\t\tnormals.push( v.normal[ j ] );\r\n\r\n\t\t\t\t}\r\n\r\n\t\t\t\tfor ( var j = 0, jl = v.uv.length; j < jl; j ++ ) {\r\n\r\n\t\t\t\t\tuvs.push( v.uv[ j ] );\r\n\r\n\t\t\t\t}\r\n\r\n\t\t\t\tfor ( var j = 0; j < 4; j ++ ) {\r\n\r\n\t\t\t\t\tskinIndices.push( v.skinIndices.length - 1 >= j ? v.skinIndices[ j ] : 0.0 );\r\n\r\n\t\t\t\t}\r\n\r\n\t\t\t\tfor ( var j = 0; j < 4; j ++ ) {\r\n\r\n\t\t\t\t\tskinWeights.push( v.skinWeights.length - 1 >= j ? v.skinWeights[ j ] : 0.0 );\r\n\r\n\t\t\t\t}\r\n\r\n\t\t\t}\r\n\r\n\t\t\t// indices\r\n\r\n\t\t\tfor ( var i = 0; i < data.metadata.faceCount; i ++ ) {\r\n\r\n\t\t\t\tvar face = data.faces[ i ];\r\n\r\n\t\t\t\tfor ( var j = 0, jl = face.indices.length; j < jl; j ++ ) {\r\n\r\n\t\t\t\t\tindices.push( face.indices[ j ] );\r\n\r\n\t\t\t\t}\r\n\r\n\t\t\t}\r\n\r\n\t\t\t// groups\r\n\r\n\t\t\tfor ( var i = 0; i < data.metadata.materialCount; i ++ ) {\r\n\r\n\t\t\t\tvar material = data.materials[ i ];\r\n\r\n\t\t\t\tgroups.push( {\r\n\t\t\t\t\toffset: offset * 3,\r\n\t\t\t\t\tcount: material.faceCount * 3\r\n\t\t\t\t} );\r\n\r\n\t\t\t\toffset += material.faceCount;\r\n\r\n\t\t\t}\r\n\r\n\t\t\t// bones\r\n\r\n\t\t\tfor ( var i = 0; i < data.metadata.rigidBodyCount; i ++ ) {\r\n\r\n\t\t\t\tvar body = data.rigidBodies[ i ];\r\n\t\t\t\tvar value = boneTypeTable[ body.boneIndex ];\r\n\r\n\t\t\t\t// keeps greater number if already value is set without any special reasons\r\n\t\t\t\tvalue = value === undefined ? body.type : Math.max( body.type, value );\r\n\r\n\t\t\t\tboneTypeTable[ body.boneIndex ] = value;\r\n\r\n\t\t\t}\r\n\r\n\t\t\tfor ( var i = 0; i < data.metadata.boneCount; i ++ ) {\r\n\r\n\t\t\t\tvar boneData = data.bones[ i ];\r\n\r\n\t\t\t\tvar bone = {\r\n\t\t\t\t\tparent: boneData.parentIndex,\r\n\t\t\t\t\tname: boneData.name,\r\n\t\t\t\t\tpos: boneData.position.slice( 0, 3 ),\r\n\t\t\t\t\trotq: [ 0, 0, 0, 1 ],\r\n\t\t\t\t\tscl: [ 1, 1, 1 ],\r\n\t\t\t\t\trigidBodyType: boneTypeTable[ i ] !== undefined ? boneTypeTable[ i ] : - 1\r\n\t\t\t\t};\r\n\r\n\t\t\t\tif ( bone.parent !== - 1 ) {\r\n\r\n\t\t\t\t\tbone.pos[ 0 ] -= data.bones[ bone.parent ].position[ 0 ];\r\n\t\t\t\t\tbone.pos[ 1 ] -= data.bones[ bone.parent ].position[ 1 ];\r\n\t\t\t\t\tbone.pos[ 2 ] -= data.bones[ bone.parent ].position[ 2 ];\r\n\r\n\t\t\t\t}\r\n\r\n\t\t\t\tbones.push( bone );\r\n\r\n\t\t\t}\r\n\r\n\t\t\t// iks\r\n\r\n\t\t\t// TODO: remove duplicated codes between PMD and PMX\r\n\t\t\tif ( data.metadata.format === 'pmd' ) {\r\n\r\n\t\t\t\tfor ( var i = 0; i < data.metadata.ikCount; i ++ ) {\r\n\r\n\t\t\t\t\tvar ik = data.iks[ i ];\r\n\r\n\t\t\t\t\tvar param = {\r\n\t\t\t\t\t\ttarget: ik.target,\r\n\t\t\t\t\t\teffector: ik.effector,\r\n\t\t\t\t\t\titeration: ik.iteration,\r\n\t\t\t\t\t\tmaxAngle: ik.maxAngle * 4,\r\n\t\t\t\t\t\tlinks: []\r\n\t\t\t\t\t};\r\n\r\n\t\t\t\t\tfor ( var j = 0, jl = ik.links.length; j < jl; j ++ ) {\r\n\r\n\t\t\t\t\t\tvar link = {};\r\n\t\t\t\t\t\tlink.index = ik.links[ j ].index;\r\n\t\t\t\t\t\tlink.enabled = true;\r\n\r\n\t\t\t\t\t\tif ( data.bones[ link.index ].name.indexOf( '' ) >= 0 ) {\r\n\r\n\t\t\t\t\t\t\tlink.limitation = new Vector3( 1.0, 0.0, 0.0 );\r\n\r\n\t\t\t\t\t\t}\r\n\r\n\t\t\t\t\t\tparam.links.push( link );\r\n\r\n\t\t\t\t\t}\r\n\r\n\t\t\t\t\tiks.push( param );\r\n\r\n\t\t\t\t}\r\n\r\n\t\t\t} else {\r\n\r\n\t\t\t\tfor ( var i = 0; i < data.metadata.boneCount; i ++ ) {\r\n\r\n\t\t\t\t\tvar ik = data.bones[ i ].ik;\r\n\r\n\t\t\t\t\tif ( ik === undefined ) continue;\r\n\r\n\t\t\t\t\tvar param = {\r\n\t\t\t\t\t\ttarget: i,\r\n\t\t\t\t\t\teffector: ik.effector,\r\n\t\t\t\t\t\titeration: ik.iteration,\r\n\t\t\t\t\t\tmaxAngle: ik.maxAngle,\r\n\t\t\t\t\t\tlinks: []\r\n\t\t\t\t\t};\r\n\r\n\t\t\t\t\tfor ( var j = 0, jl = ik.links.length; j < jl; j ++ ) {\r\n\r\n\t\t\t\t\t\tvar link = {};\r\n\t\t\t\t\t\tlink.index = ik.links[ j ].index;\r\n\t\t\t\t\t\tlink.enabled = true;\r\n\r\n\t\t\t\t\t\tif ( ik.links[ j ].angleLimitation === 1 ) {\r\n\r\n\t\t\t\t\t\t\t// Revert if rotationMin/Max doesn't work well\r\n\t\t\t\t\t\t\t// link.limitation = new Vector3( 1.0, 0.0, 0.0 );\r\n\r\n\t\t\t\t\t\t\tvar rotationMin = ik.links[ j ].lowerLimitationAngle;\r\n\t\t\t\t\t\t\tvar rotationMax = ik.links[ j ].upperLimitationAngle;\r\n\r\n\t\t\t\t\t\t\t// Convert Left to Right coordinate by myself because\r\n\t\t\t\t\t\t\t// MMDParser doesn't convert. It's a MMDParser's bug\r\n\r\n\t\t\t\t\t\t\tvar tmp1 = - rotationMax[ 0 ];\r\n\t\t\t\t\t\t\tvar tmp2 = - rotationMax[ 1 ];\r\n\t\t\t\t\t\t\trotationMax[ 0 ] = - rotationMin[ 0 ];\r\n\t\t\t\t\t\t\trotationMax[ 1 ] = - rotationMin[ 1 ];\r\n\t\t\t\t\t\t\trotationMin[ 0 ] = tmp1;\r\n\t\t\t\t\t\t\trotationMin[ 1 ] = tmp2;\r\n\r\n\t\t\t\t\t\t\tlink.rotationMin = new Vector3().fromArray( rotationMin );\r\n\t\t\t\t\t\t\tlink.rotationMax = new Vector3().fromArray( rotationMax );\r\n\r\n\t\t\t\t\t\t}\r\n\r\n\t\t\t\t\t\tparam.links.push( link );\r\n\r\n\t\t\t\t\t}\r\n\r\n\t\t\t\t\tiks.push( param );\r\n\r\n\t\t\t\t}\r\n\r\n\t\t\t}\r\n\r\n\t\t\t// grants\r\n\r\n\t\t\tif ( data.metadata.format === 'pmx' ) {\r\n\r\n\t\t\t\tfor ( var i = 0; i < data.metadata.boneCount; i ++ ) {\r\n\r\n\t\t\t\t\tvar boneData = data.bones[ i ];\r\n\t\t\t\t\tvar grant = boneData.grant;\r\n\r\n\t\t\t\t\tif ( grant === undefined ) continue;\r\n\r\n\t\t\t\t\tvar param = {\r\n\t\t\t\t\t\tindex: i,\r\n\t\t\t\t\t\tparentIndex: grant.parentIndex,\r\n\t\t\t\t\t\tratio: grant.ratio,\r\n\t\t\t\t\t\tisLocal: grant.isLocal,\r\n\t\t\t\t\t\taffectRotation: grant.affectRotation,\r\n\t\t\t\t\t\taffectPosition: grant.affectPosition,\r\n\t\t\t\t\t\ttransformationClass: boneData.transformationClass\r\n\t\t\t\t\t};\r\n\r\n\t\t\t\t\tgrants.push( param );\r\n\r\n\t\t\t\t}\r\n\r\n\t\t\t\tgrants.sort( function ( a, b ) {\r\n\r\n\t\t\t\t\treturn a.transformationClass - b.transformationClass;\r\n\r\n\t\t\t\t} );\r\n\r\n\t\t\t}\r\n\r\n\t\t\t// morph\r\n\r\n\t\t\tfunction updateAttributes( attribute, morph, ratio ) {\r\n\r\n\t\t\t\tfor ( var i = 0; i < morph.elementCount; i ++ ) {\r\n\r\n\t\t\t\t\tvar element = morph.elements[ i ];\r\n\r\n\t\t\t\t\tvar index;\r\n\r\n\t\t\t\t\tif ( data.metadata.format === 'pmd' ) {\r\n\r\n\t\t\t\t\t\tindex = data.morphs[ 0 ].elements[ element.index ].index;\r\n\r\n\t\t\t\t\t} else {\r\n\r\n\t\t\t\t\t\tindex = element.index;\r\n\r\n\t\t\t\t\t}\r\n\r\n\t\t\t\t\tattribute.array[ index * 3 + 0 ] += element.position[ 0 ] * ratio;\r\n\t\t\t\t\tattribute.array[ index * 3 + 1 ] += element.position[ 1 ] * ratio;\r\n\t\t\t\t\tattribute.array[ index * 3 + 2 ] += element.position[ 2 ] * ratio;\r\n\r\n\t\t\t\t}\r\n\r\n\t\t\t}\r\n\r\n\t\t\tfor ( var i = 0; i < data.metadata.morphCount; i ++ ) {\r\n\r\n\t\t\t\tvar morph = data.morphs[ i ];\r\n\t\t\t\tvar params = { name: morph.name };\r\n\r\n\t\t\t\tvar attribute = new Float32BufferAttribute( data.metadata.vertexCount * 3, 3 );\r\n\t\t\t\tattribute.name = morph.name;\r\n\r\n\t\t\t\tfor ( var j = 0; j < data.metadata.vertexCount * 3; j ++ ) {\r\n\r\n\t\t\t\t\tattribute.array[ j ] = positions[ j ];\r\n\r\n\t\t\t\t}\r\n\r\n\t\t\t\tif ( data.metadata.format === 'pmd' ) {\r\n\r\n\t\t\t\t\tif ( i !== 0 ) {\r\n\r\n\t\t\t\t\t\tupdateAttributes( attribute, morph, 1.0 );\r\n\r\n\t\t\t\t\t}\r\n\r\n\t\t\t\t} else {\r\n\r\n\t\t\t\t\tif ( morph.type === 0 ) { // group\r\n\r\n\t\t\t\t\t\tfor ( var j = 0; j < morph.elementCount; j ++ ) {\r\n\r\n\t\t\t\t\t\t\tvar morph2 = data.morphs[ morph.elements[ j ].index ];\r\n\t\t\t\t\t\t\tvar ratio = morph.elements[ j ].ratio;\r\n\r\n\t\t\t\t\t\t\tif ( morph2.type === 1 ) {\r\n\r\n\t\t\t\t\t\t\t\tupdateAttributes( attribute, morph2, ratio );\r\n\r\n\t\t\t\t\t\t\t} else {\r\n\r\n\t\t\t\t\t\t\t\t// TODO: implement\r\n\r\n\t\t\t\t\t\t\t}\r\n\r\n\t\t\t\t\t\t}\r\n\r\n\t\t\t\t\t} else if ( morph.type === 1 ) { // vertex\r\n\r\n\t\t\t\t\t\tupdateAttributes( attribute, morph, 1.0 );\r\n\r\n\t\t\t\t\t} else if ( morph.type === 2 ) { // bone\r\n\r\n\t\t\t\t\t\t// TODO: implement\r\n\r\n\t\t\t\t\t} else if ( morph.type === 3 ) { // uv\r\n\r\n\t\t\t\t\t\t// TODO: implement\r\n\r\n\t\t\t\t\t} else if ( morph.type === 4 ) { // additional uv1\r\n\r\n\t\t\t\t\t\t// TODO: implement\r\n\r\n\t\t\t\t\t} else if ( morph.type === 5 ) { // additional uv2\r\n\r\n\t\t\t\t\t\t// TODO: implement\r\n\r\n\t\t\t\t\t} else if ( morph.type === 6 ) { // additional uv3\r\n\r\n\t\t\t\t\t\t// TODO: implement\r\n\r\n\t\t\t\t\t} else if ( morph.type === 7 ) { // additional uv4\r\n\r\n\t\t\t\t\t\t// TODO: implement\r\n\r\n\t\t\t\t\t} else if ( morph.type === 8 ) { // material\r\n\r\n                        // TODO: implement\r\n                        // console.log('material=' + morph.name);\r\n\r\n\t\t\t\t\t}\r\n\r\n\t\t\t\t}\r\n\r\n\t\t\t\tmorphTargets.push( params );\r\n\t\t\t\tmorphPositions.push( attribute );\r\n\r\n\t\t\t}\r\n\r\n\t\t\t// rigid bodies from rigidBodies field.\r\n\r\n\t\t\tfor ( var i = 0; i < data.metadata.rigidBodyCount; i ++ ) {\r\n\r\n\t\t\t\tvar rigidBody = data.rigidBodies[ i ];\r\n\t\t\t\tvar params = {};\r\n\r\n\t\t\t\tfor ( var key in rigidBody ) {\r\n\r\n\t\t\t\t\tparams[ key ] = rigidBody[ key ];\r\n\r\n\t\t\t\t}\r\n\r\n\t\t\t\t/*\r\n\t\t\t\t * RigidBody position parameter in PMX seems global position\r\n\t\t\t\t * while the one in PMD seems offset from corresponding bone.\r\n\t\t\t\t * So unify being offset.\r\n\t\t\t\t */\r\n\t\t\t\tif ( data.metadata.format === 'pmx' ) {\r\n\r\n\t\t\t\t\tif ( params.boneIndex !== - 1 ) {\r\n\r\n\t\t\t\t\t\tvar bone = data.bones[ params.boneIndex ];\r\n\t\t\t\t\t\tparams.position[ 0 ] -= bone.position[ 0 ];\r\n\t\t\t\t\t\tparams.position[ 1 ] -= bone.position[ 1 ];\r\n\t\t\t\t\t\tparams.position[ 2 ] -= bone.position[ 2 ];\r\n\r\n\t\t\t\t\t}\r\n\r\n\t\t\t\t}\r\n\r\n\t\t\t\trigidBodies.push( params );\r\n\r\n\t\t\t}\r\n\r\n\t\t\t// constraints from constraints field.\r\n\r\n\t\t\tfor ( var i = 0; i < data.metadata.constraintCount; i ++ ) {\r\n\r\n\t\t\t\tvar constraint = data.constraints[ i ];\r\n\t\t\t\tvar params = {};\r\n\r\n\t\t\t\tfor ( var key in constraint ) {\r\n\r\n\t\t\t\t\tparams[ key ] = constraint[ key ];\r\n\r\n\t\t\t\t}\r\n\r\n\t\t\t\tvar bodyA = rigidBodies[ params.rigidBodyIndex1 ];\r\n\t\t\t\tvar bodyB = rigidBodies[ params.rigidBodyIndex2 ];\r\n\r\n\t\t\t\t// Refer to http://www20.atpages.jp/katwat/wp/?p=4135\r\n\t\t\t\tif ( bodyA.type !== 0 && bodyB.type === 2 ) {\r\n\r\n\t\t\t\t\tif ( bodyA.boneIndex !== - 1 && bodyB.boneIndex !== - 1 &&\r\n\t\t\t\t\t     data.bones[ bodyB.boneIndex ].parentIndex === bodyA.boneIndex ) {\r\n\r\n\t\t\t\t\t\tbodyB.type = 1;\r\n\r\n\t\t\t\t\t}\r\n\r\n\t\t\t\t}\r\n\r\n\t\t\t\tconstraints.push( params );\r\n\r\n\t\t\t}\r\n\r\n\t\t\t// build BufferGeometry.\r\n\r\n\t\t\tvar geometry = new BufferGeometry();\r\n\r\n\t\t\tgeometry.setAttribute( 'position', new Float32BufferAttribute( positions, 3 ) );\r\n\t\t\tgeometry.setAttribute( 'normal', new Float32BufferAttribute( normals, 3 ) );\r\n\t\t\tgeometry.setAttribute( 'uv', new Float32BufferAttribute( uvs, 2 ) );\r\n\t\t\tgeometry.setAttribute( 'skinIndex', new Uint16BufferAttribute( skinIndices, 4 ) );\r\n\t\t\tgeometry.setAttribute( 'skinWeight', new Float32BufferAttribute( skinWeights, 4 ) );\r\n\t\t\tgeometry.setIndex( indices );\r\n\r\n\t\t\tfor ( var i = 0, il = groups.length; i < il; i ++ ) {\r\n\r\n\t\t\t\tgeometry.addGroup( groups[ i ].offset, groups[ i ].count, i );\r\n\r\n\t\t\t}\r\n\r\n\t\t\tgeometry.bones = bones;\r\n\t\t\tgeometry.morphTargets = morphTargets;\r\n\t\t\tgeometry.morphAttributes.position = morphPositions;\r\n            geometry.morphTargetsRelative = false;\r\n            // console.log(data);\r\n\r\n\t\t\tgeometry.userData.MMD = {\r\n\t\t\t\tbones: bones,\r\n\t\t\t\tiks: iks,\r\n\t\t\t\tgrants: grants,\r\n\t\t\t\trigidBodies: rigidBodies,\r\n\t\t\t\tconstraints: constraints,\r\n                format: data.metadata.format,\r\n                // \r\n                morphs: data.morphs,\r\n                frames: data.frames,\r\n                modelName: data.metadata.modelName,\r\n                englishModelName: data.metadata.englishModelName,\r\n                comment: data.metadata.comment,\r\n                englishComment: data.metadata.englishComment,\r\n\t\t\t};\r\n\r\n\t\t\tgeometry.computeBoundingSphere();\r\n\r\n\t\t\treturn geometry;\r\n\r\n\t\t}\r\n\r\n\t};\r\n\r\n\t//\r\n\r\n\t/**\r\n\t * @param {THREE.LoadingManager} manager\r\n\t */\r\n\tfunction MaterialBuilder( manager ) {\r\n\r\n\t\tthis.manager = manager;\r\n\r\n\t\tthis.textureLoader = new TextureLoader( this.manager );\r\n\t\tthis.tgaLoader = null; // lazy generation\r\n\r\n\t}\r\n\r\n\tMaterialBuilder.prototype = {\r\n\r\n\t\tconstructor: MaterialBuilder,\r\n\r\n\t\tcrossOrigin: 'anonymous',\r\n\r\n\t\tresourcePath: undefined,\r\n\r\n\t\tresourceDir: undefined,\r\n\r\n\t\t/**\r\n\t\t * @param {string} crossOrigin\r\n\t\t * @return {MaterialBuilder}\r\n\t\t */\r\n\t\tsetCrossOrigin: function ( crossOrigin ) {\r\n\r\n\t\t\tthis.crossOrigin = crossOrigin;\r\n\t\t\treturn this;\r\n\r\n\t\t},\r\n\r\n\t\t/**\r\n\t\t * @param {string} resourcePath\r\n\t\t * @return {MaterialBuilder}\r\n\t\t */\r\n\t\tsetResourcePath: function ( resourcePath ) {\r\n\r\n\t\t\tthis.resourcePath = resourcePath;\r\n\t\t\treturn this;\r\n\r\n\t\t},\r\n\r\n\t\tsetResourceDir: function ( resourceDir ) {\r\n\t\t\tthis.resourceDir = resourceDir;\r\n\t\t\treturn this;\r\n\t\t},\r\n\r\n\t\t/**\r\n\t\t * @param {Object} data - parsed PMD/PMX data\r\n\t\t * @param {BufferGeometry} geometry - some properties are dependend on geometry\r\n\t\t * @param {function} onProgress\r\n\t\t * @param {function} onError\r\n\t\t * @return {Array<MeshToonMaterial>}\r\n\t\t */\r\n\t\tbuild: function ( data, geometry /*, onProgress, onError */ ) {\r\n\r\n\t\t\tvar materials = [];\r\n\r\n\t\t\tvar textures = {};\r\n\r\n\t\t\tthis.textureLoader.setCrossOrigin( this.crossOrigin );\r\n\r\n\t\t\t// materials\r\n\r\n\t\t\tfor ( var i = 0; i < data.metadata.materialCount; i ++ ) {\r\n\r\n\t\t\t\tvar material = data.materials[ i ];\r\n\r\n\t\t\t\tvar params = { userData: {} };\r\n\r\n\t\t\t\tif ( material.name !== undefined ) params.name = material.name;\r\n\r\n\t\t\t\t/*\r\n\t\t\t\t * Color\r\n\t\t\t\t *\r\n\t\t\t\t * MMD         MeshToonMaterial\r\n\t\t\t\t * diffuse  -  color\r\n\t\t\t\t * ambient  -  emissive * a\r\n\t\t\t\t *               (a = 1.0 without map texture or 0.2 with map texture)\r\n\t\t\t\t *\r\n\t\t\t\t * MeshToonMaterial doesn't have ambient. Set it to emissive instead.\r\n\t\t\t\t * It'll be too bright if material has map texture so using coef 0.2.\r\n\t\t\t\t */\r\n\t\t\t\tparams.color = new Color().fromArray( material.diffuse );\r\n\t\t\t\tparams.opacity = material.diffuse[ 3 ];\r\n\t\t\t\tparams.emissive = new Color().fromArray( material.ambient );\r\n\t\t\t\tparams.transparent = params.opacity !== 1.0;\r\n\r\n\t\t\t\t//\r\n\r\n\t\t\t\tparams.skinning = geometry.bones.length > 0 ? true : false;\r\n\t\t\t\tparams.morphTargets = geometry.morphTargets.length > 0 ? true : false;\r\n\t\t\t\tparams.fog = true;\r\n\r\n\t\t\t\t// blend\r\n\r\n\t\t\t\tparams.blending = CustomBlending;\r\n\t\t\t\tparams.blendSrc = SrcAlphaFactor;\r\n\t\t\t\tparams.blendDst = OneMinusSrcAlphaFactor;\r\n\t\t\t\tparams.blendSrcAlpha = SrcAlphaFactor;\r\n\t\t\t\tparams.blendDstAlpha = DstAlphaFactor;\r\n\r\n\t\t\t\t// side\r\n\r\n\t\t\t\tif ( data.metadata.format === 'pmx' && ( material.flag & 0x1 ) === 1 ) {\r\n\r\n\t\t\t\t\tparams.side = DoubleSide;\r\n\r\n\t\t\t\t} else {\r\n\r\n\t\t\t\t\tparams.side = params.opacity === 1.0 ? FrontSide : DoubleSide;\r\n\r\n\t\t\t\t}\r\n\r\n\t\t\t\tif ( data.metadata.format === 'pmd' ) {\r\n\r\n\t\t\t\t\t// map, envMap\r\n\r\n\t\t\t\t\tif ( material.fileName ) {\r\n\r\n\t\t\t\t\t\tvar fileName = material.fileName;\r\n\t\t\t\t\t\tvar fileNames = fileName.split( '*' );\r\n\r\n\t\t\t\t\t\t// fileNames[ 0 ]: mapFileName\r\n\t\t\t\t\t\t// fileNames[ 1 ]: envMapFileName( optional )\r\n\r\n\t\t\t\t\t\tparams.map = this._loadTexture( fileNames[ 0 ], textures );\r\n\r\n\t\t\t\t\t\tif ( fileNames.length > 1 ) {\r\n\r\n\t\t\t\t\t\t\tvar extension = fileNames[ 1 ].slice( - 4 ).toLowerCase();\r\n\r\n\t\t\t\t\t\t\tparams.envMap = this._loadTexture(\r\n\t\t\t\t\t\t\t\tfileNames[ 1 ],\r\n\t\t\t\t\t\t\t\ttextures\r\n\t\t\t\t\t\t\t);\r\n\r\n\t\t\t\t\t\t\tparams.combine = extension === '.sph'\r\n\t\t\t\t\t\t\t\t? MultiplyOperation\r\n\t\t\t\t\t\t\t\t: AddOperation;\r\n\r\n\t\t\t\t\t\t}\r\n\r\n\t\t\t\t\t}\r\n\r\n\t\t\t\t\t// gradientMap\r\n\r\n\t\t\t\t\tvar toonFileName = ( material.toonIndex === - 1 )\r\n\t\t\t\t\t\t? 'toon00.bmp'\r\n\t\t\t\t\t\t: data.toonTextures[ material.toonIndex ].fileName;\r\n\r\n\t\t\t\t\tparams.gradientMap = this._loadTexture(\r\n\t\t\t\t\t\ttoonFileName,\r\n\t\t\t\t\t\ttextures,\r\n\t\t\t\t\t\t{\r\n\t\t\t\t\t\t\tisToonTexture: true,\r\n\t\t\t\t\t\t\tisDefaultToonTexture: this._isDefaultToonTexture( toonFileName )\r\n\t\t\t\t\t\t}\r\n\t\t\t\t\t);\r\n\r\n\t\t\t\t\t// parameters for OutlineEffect\r\n\r\n\t\t\t\t\tparams.userData.outlineParameters = {\r\n\t\t\t\t\t\tthickness: material.edgeFlag === 1 ? 0.003 : 0.0,\r\n\t\t\t\t\t\tcolor: [ 0, 0, 0 ],\r\n\t\t\t\t\t\talpha: 1.0,\r\n\t\t\t\t\t\tvisible: material.edgeFlag === 1\r\n\t\t\t\t\t};\r\n\r\n\t\t\t\t} else {\r\n\r\n\t\t\t\t\t// map\r\n\r\n\t\t\t\t\tif ( material.textureIndex !== - 1 ) {\r\n\r\n\t\t\t\t\t\tparams.map = this._loadTexture( data.textures[ material.textureIndex ], textures );\r\n\t\t\t\t\t}\r\n\r\n\t\t\t\t\t// envMap TODO: support m.envFlag === 3\r\n\r\n\t\t\t\t\tif ( material.envTextureIndex !== - 1 && ( material.envFlag === 1 || material.envFlag == 2 ) ) {\r\n\r\n\t\t\t\t\t\tparams.envMap = this._loadTexture(\r\n\t\t\t\t\t\t\tdata.textures[ material.envTextureIndex ],\r\n\t\t\t\t\t\t\ttextures\r\n\t\t\t\t\t\t);\r\n\r\n\t\t\t\t\t\tparams.combine = material.envFlag === 1\r\n\t\t\t\t\t\t\t? MultiplyOperation\r\n\t\t\t\t\t\t\t: AddOperation;\r\n\r\n\t\t\t\t\t}\r\n\r\n\t\t\t\t\t// gradientMap\r\n\r\n\t\t\t\t\tvar toonFileName, isDefaultToon;\r\n\r\n\t\t\t\t\tif ( material.toonIndex === - 1 || material.toonFlag !== 0 ) {\r\n\r\n\t\t\t\t\t\ttoonFileName = 'toon' + ( '0' + ( material.toonIndex + 1 ) ).slice( - 2 ) + '.bmp';\r\n\t\t\t\t\t\tisDefaultToon = true;\r\n\r\n\t\t\t\t\t} else {\r\n\r\n\t\t\t\t\t\ttoonFileName = data.textures[ material.toonIndex ];\r\n\t\t\t\t\t\tisDefaultToon = false;\r\n\r\n\t\t\t\t\t}\r\n\t\t\t\t\tparams.gradientMap = this._loadTexture(\r\n\t\t\t\t\t\ttoonFileName,\r\n\t\t\t\t\t\ttextures,\r\n\t\t\t\t\t\t{\r\n\t\t\t\t\t\t\tisToonTexture: true,\r\n\t\t\t\t\t\t\tisDefaultToonTexture: isDefaultToon\r\n\t\t\t\t\t\t}\r\n\t\t\t\t\t);\r\n\r\n\t\t\t\t\t// parameters for OutlineEffect\r\n\t\t\t\t\tparams.userData.outlineParameters = {\r\n\t\t\t\t\t\tthickness: material.edgeSize / 300, // TODO: better calculation?\r\n\t\t\t\t\t\tcolor: material.edgeColor.slice( 0, 3 ),\r\n\t\t\t\t\t\talpha: material.edgeColor[ 3 ],\r\n\t\t\t\t\t\tvisible: ( material.flag & 0x10 ) !== 0 && material.edgeSize > 0.0\r\n\t\t\t\t\t};\r\n\r\n\t\t\t\t}\r\n\r\n\t\t\t\tif ( params.map !== undefined ) {\r\n\r\n\t\t\t\t\tif ( ! params.transparent ) {\r\n\t\t\t\t\t\tthis._checkImageTransparency( params.map, geometry, i );\r\n\r\n\t\t\t\t\t}\r\n\r\n\t\t\t\t\tparams.emissive.multiplyScalar( 0.2 );\r\n\r\n\t\t\t\t}\r\n\r\n\t\t\t\tmaterials.push( new MeshToonMaterial( params ) );\r\n\r\n\t\t\t}\r\n\r\n\t\t\tif ( data.metadata.format === 'pmx' ) {\r\n\r\n\t\t\t\t// set transparent true if alpha morph is defined.\r\n\r\n\t\t\t\tfunction checkAlphaMorph( elements, materials ) {\r\n\r\n\t\t\t\t\tfor ( var i = 0, il = elements.length; i < il; i ++ ) {\r\n\r\n\t\t\t\t\t\tvar element = elements[ i ];\r\n\r\n\t\t\t\t\t\tif ( element.index === - 1 ) continue;\r\n\r\n\t\t\t\t\t\tvar material = materials[ element.index ];\r\n\r\n\t\t\t\t\t\tif ( material.opacity !== element.diffuse[ 3 ] ) {\r\n\r\n\t\t\t\t\t\t\tmaterial.transparent = true;\r\n\r\n\t\t\t\t\t\t}\r\n\r\n\t\t\t\t\t}\r\n\r\n\t\t\t\t}\r\n\r\n\t\t\t\tfor ( var i = 0, il = data.morphs.length; i < il; i ++ ) {\r\n\r\n\t\t\t\t\tvar morph = data.morphs[ i ];\r\n\t\t\t\t\tvar elements = morph.elements;\r\n\r\n\t\t\t\t\tif ( morph.type === 0 ) {\r\n\r\n\t\t\t\t\t\tfor ( var j = 0, jl = elements.length; j < jl; j ++ ) {\r\n\r\n\t\t\t\t\t\t\tvar morph2 = data.morphs[ elements[ j ].index ];\r\n\r\n\t\t\t\t\t\t\tif ( morph2.type !== 8 ) continue;\r\n\r\n\t\t\t\t\t\t\tcheckAlphaMorph( morph2.elements, materials );\r\n\r\n\t\t\t\t\t\t}\r\n\r\n\t\t\t\t\t} else if ( morph.type === 8 ) {\r\n\r\n\t\t\t\t\t\tcheckAlphaMorph( elements, materials );\r\n\r\n\t\t\t\t\t}\r\n\r\n\t\t\t\t}\r\n\r\n\t\t\t}\r\n\r\n\t\t\treturn materials;\r\n\r\n\t\t},\r\n\r\n\t\t// private methods\r\n\r\n\t\t_getTGALoader: function () {\r\n\r\n\t\t\tif ( this.tgaLoader === null ) {\r\n\r\n\t\t\t\tif ( TGALoader === undefined ) {\r\n\r\n\t\t\t\t\tthrow new Error( 'THREE.MMDLoader: Import TGALoader' );\r\n\r\n\t\t\t\t}\r\n\r\n\t\t\t\tthis.tgaLoader = new TGALoader( this.manager );\r\n\r\n\t\t\t}\r\n\r\n\t\t\treturn this.tgaLoader;\r\n\r\n\t\t},\r\n\r\n\t\t_isDefaultToonTexture: function ( name ) {\r\n\r\n\t\t\tif ( name.length !== 10 ) return false;\r\n\r\n\t\t\treturn /toon(10|0[0-9])\\.bmp/.test( name );\r\n\r\n\t\t},\r\n\r\n\t\t_loadTexture: function ( filePath, textures, params, onProgress, onError ) {\r\n\t\t\tparams = params || {};\r\n\r\n\t\t\tvar scope = this;\r\n\r\n\t\t\tvar fullPath;\r\n\r\n\t\t\tif ( params.isDefaultToonTexture === true ) {\r\n\r\n\t\t\t\tvar index;\r\n\r\n\t\t\t\ttry {\r\n\r\n\t\t\t\t\tindex = parseInt( filePath.match( /toon([0-9]{2})\\.bmp$/ )[ 1 ] );\r\n\r\n\t\t\t\t} catch ( e ) {\r\n\r\n\t\t\t\t\tconsole.warn( 'THREE.MMDLoader: ' + filePath + ' seems like a '\r\n\t\t\t\t\t\t+ 'not right default texture path. Using toon00.bmp instead.' );\r\n\r\n\t\t\t\t\tindex = 0;\r\n\r\n\t\t\t\t}\r\n\r\n\t\t\t\tfullPath = DEFAULT_TOON_TEXTURES[ index ];\r\n\r\n\t\t\t} else {\r\n\r\n\t\t\t\t// fullPath = this.resourcePath + filePath;\r\n\t\t\t\tfullPath = this.resourceDir[filePath];\r\n\t\t\t}\r\n\t\t\tif ( textures[ fullPath ] !== undefined ) return textures[ fullPath ];\r\n\r\n\t\t\tvar loader = this.manager.getHandler( fullPath );\r\n\t\t\tif ( loader === null ) {\r\n\t\t\t\tloader = ( filePath.slice( - 4 ).toLowerCase() === '.tga' )\r\n\t\t\t\t\t? this._getTGALoader()\r\n\t\t\t\t\t: this.textureLoader;\r\n\r\n\t\t\t}\r\n\r\n\t\t\tvar texture = loader.load( fullPath, function ( t ) {\r\n\r\n\t\t\t\t// MMD toon texture is Axis-Y oriented\r\n\t\t\t\t// but Three.js gradient map is Axis-X oriented.\r\n\t\t\t\t// So here replaces the toon texture image with the rotated one.\r\n\t\t\t\tif ( params.isToonTexture === true ) {\r\n\r\n\t\t\t\t\tt.image = scope._getRotatedImage( t.image );\r\n\r\n\t\t\t\t\tt.magFilter = NearestFilter;\r\n\t\t\t\t\tt.minFilter = NearestFilter;\r\n\r\n\t\t\t\t}\r\n\r\n\t\t\t\tt.flipY = false;\r\n\t\t\t\tt.wrapS = RepeatWrapping;\r\n\t\t\t\tt.wrapT = RepeatWrapping;\r\n\r\n\t\t\t\tfor ( var i = 0; i < texture.readyCallbacks.length; i ++ ) {\r\n\r\n\t\t\t\t\ttexture.readyCallbacks[ i ]( texture );\r\n\r\n\t\t\t\t}\r\n\r\n\t\t\t\tdelete texture.readyCallbacks;\r\n\r\n\t\t\t}, onProgress, onError );\r\n\r\n\t\t\ttexture.readyCallbacks = [];\r\n\r\n\t\t\ttextures[ fullPath ] = texture;\r\n\t\t\treturn texture;\r\n\r\n\t\t},\r\n\r\n\t\t_getRotatedImage: function ( image ) {\r\n\r\n\t\t\tvar canvas = document.createElement( 'canvas' );\r\n\t\t\tvar context = canvas.getContext( '2d' );\r\n\r\n\t\t\tvar width = image.width;\r\n\t\t\tvar height = image.height;\r\n\r\n\t\t\tcanvas.width = width;\r\n\t\t\tcanvas.height = height;\r\n\r\n\t\t\tcontext.clearRect( 0, 0, width, height );\r\n\t\t\tcontext.translate( width / 2.0, height / 2.0 );\r\n\t\t\tcontext.rotate( 0.5 * Math.PI ); // 90.0 * Math.PI / 180.0\r\n\t\t\tcontext.translate( - width / 2.0, - height / 2.0 );\r\n\t\t\tcontext.drawImage( image, 0, 0 );\r\n\r\n\t\t\treturn context.getImageData( 0, 0, width, height );\r\n\r\n\t\t},\r\n\r\n\t\t// Check if the partial image area used by the texture is transparent.\r\n\t\t_checkImageTransparency: async function ( map, geometry, groupIndex ) {\r\n\t\t\tmap.readyCallbacks.push( function ( texture ) {\r\n\r\n\t\t\t\t// Is there any efficient ways?\r\n\t\t\t\tfunction createImageData( image ) {\r\n\r\n\t\t\t\t\tvar canvas = document.createElement( 'canvas' );\r\n\t\t\t\t\tcanvas.width = image.width;\r\n\t\t\t\t\tcanvas.height = image.height;\r\n\r\n\t\t\t\t\tvar context = canvas.getContext( '2d' );\r\n\t\t\t\t\tcontext.drawImage( image, 0, 0 );\r\n\r\n\t\t\t\t\treturn context.getImageData( 0, 0, canvas.width, canvas.height );\r\n\r\n\t\t\t\t}\r\n\r\n\t\t\t\tfunction detectImageTransparency( image, uvs, indices ) {\r\n\r\n\t\t\t\t\tvar width = image.width;\r\n\t\t\t\t\tvar height = image.height;\r\n\t\t\t\t\tvar data = image.data;\r\n\t\t\t\t\tvar threshold = 253;\r\n\r\n\t\t\t\t\tif ( data.length / ( width * height ) !== 4 ) return false;\r\n\r\n\t\t\t\t\tfor ( var i = 0; i < indices.length; i += 3 ) {\r\n\r\n\t\t\t\t\t\tvar centerUV = { x: 0.0, y: 0.0 };\r\n\r\n\t\t\t\t\t\tfor ( var j = 0; j < 3; j ++ ) {\r\n\r\n\t\t\t\t\t\t\tvar index = indices[ i * 3 + j ];\r\n\t\t\t\t\t\t\tvar uv = { x: uvs[ index * 2 + 0 ], y: uvs[ index * 2 + 1 ] };\r\n\r\n\t\t\t\t\t\t\tif ( getAlphaByUv( image, uv ) < threshold ) return true;\r\n\r\n\t\t\t\t\t\t\tcenterUV.x += uv.x;\r\n\t\t\t\t\t\t\tcenterUV.y += uv.y;\r\n\r\n\t\t\t\t\t\t}\r\n\r\n\t\t\t\t\t\tcenterUV.x /= 3;\r\n\t\t\t\t\t\tcenterUV.y /= 3;\r\n\r\n\t\t\t\t\t\tif ( getAlphaByUv( image, centerUV ) < threshold ) return true;\r\n\r\n\t\t\t\t\t}\r\n\r\n\t\t\t\t\treturn false;\r\n\r\n\t\t\t\t}\r\n\r\n\t\t\t\t/*\r\n\t\t\t\t * This method expects\r\n\t\t\t\t *   texture.flipY = false\r\n\t\t\t\t *   texture.wrapS = RepeatWrapping\r\n\t\t\t\t *   texture.wrapT = RepeatWrapping\r\n\t\t\t\t * TODO: more precise\r\n\t\t\t\t */\r\n\t\t\t\tfunction getAlphaByUv( image, uv ) {\r\n\r\n\t\t\t\t\tvar width = image.width;\r\n\t\t\t\t\tvar height = image.height;\r\n\r\n\t\t\t\t\tvar x = Math.round( uv.x * width ) % width;\r\n\t\t\t\t\tvar y = Math.round( uv.y * height ) % height;\r\n\r\n\t\t\t\t\tif ( x < 0 ) x += width;\r\n\t\t\t\t\tif ( y < 0 ) y += height;\r\n\r\n\t\t\t\t\tvar index = y * width + x;\r\n\r\n\t\t\t\t\treturn image.data[ index * 4 + 3 ];\r\n\r\n\t\t\t\t}\r\n\r\n\t\t\t\tvar imageData = texture.image.data !== undefined\r\n\t\t\t\t\t? texture.image\r\n\t\t\t\t\t: createImageData( texture.image );\r\n\r\n\t\t\t\tvar group = geometry.groups[ groupIndex ];\r\n\r\n\t\t\t\tif ( detectImageTransparency(\r\n\t\t\t\t\timageData,\r\n\t\t\t\t\tgeometry.attributes.uv.array,\r\n\t\t\t\t\tgeometry.index.array.slice( group.start, group.start + group.count ) ) ) {\r\n\r\n\t\t\t\t\tmap.transparent = true;\r\n\r\n\t\t\t\t}\r\n\r\n\t\t\t} );\r\n\r\n\t\t}\r\n\r\n\t};\r\n\r\n\t//\r\n\r\n\tfunction AnimationBuilder() {\r\n\r\n\t}\r\n\r\n\tAnimationBuilder.prototype = {\r\n\r\n\t\tconstructor: AnimationBuilder,\r\n\r\n\t\t/**\r\n\t\t * @param {Object} vmd - parsed VMD data\r\n\t\t * @param {SkinnedMesh} mesh - tracks will be fitting to mesh\r\n\t\t * @return {AnimationClip}\r\n\t\t */\r\n\t\tbuild: function ( vmd, mesh ) {\r\n\r\n\t\t\t// combine skeletal and morph animations\r\n\r\n\t\t\tvar tracks = this.buildSkeletalAnimation( vmd, mesh ).tracks;\r\n\t\t\tvar tracks2 = this.buildMorphAnimation( vmd, mesh ).tracks;\r\n\r\n\t\t\tfor ( var i = 0, il = tracks2.length; i < il; i ++ ) {\r\n\r\n\t\t\t\ttracks.push( tracks2[ i ] );\r\n\r\n\t\t\t}\r\n\r\n\t\t\treturn new AnimationClip( '', - 1, tracks );\r\n\r\n\t\t},\r\n\r\n\t\t/**\r\n\t\t * @param {Object} vmd - parsed VMD data\r\n\t\t * @param {SkinnedMesh} mesh - tracks will be fitting to mesh\r\n\t\t * @return {AnimationClip}\r\n\t\t */\r\n\t\tbuildSkeletalAnimation: function ( vmd, mesh ) {\r\n\r\n\t\t\tfunction pushInterpolation( array, interpolation, index ) {\r\n\r\n\t\t\t\tarray.push( interpolation[ index + 0 ] / 127 ); // x1\r\n\t\t\t\tarray.push( interpolation[ index + 8 ] / 127 ); // x2\r\n\t\t\t\tarray.push( interpolation[ index + 4 ] / 127 ); // y1\r\n\t\t\t\tarray.push( interpolation[ index + 12 ] / 127 ); // y2\r\n\r\n\t\t\t}\r\n\r\n\t\t\tvar tracks = [];\r\n\r\n\t\t\tvar motions = {};\r\n\t\t\tvar bones = mesh.skeleton.bones;\r\n\t\t\tvar boneNameDictionary = {};\r\n\r\n\t\t\tfor ( var i = 0, il = bones.length; i < il; i ++ ) {\r\n\r\n\t\t\t\tboneNameDictionary[ bones[ i ].name ] = true;\r\n\r\n\t\t\t}\r\n\r\n\t\t\tfor ( var i = 0; i < vmd.metadata.motionCount; i ++ ) {\r\n\r\n\t\t\t\tvar motion = vmd.motions[ i ];\r\n\t\t\t\tvar boneName = motion.boneName;\r\n\r\n\t\t\t\tif ( boneNameDictionary[ boneName ] === undefined ) continue;\r\n\r\n\t\t\t\tmotions[ boneName ] = motions[ boneName ] || [];\r\n\t\t\t\tmotions[ boneName ].push( motion );\r\n\r\n\t\t\t}\r\n\r\n\t\t\tfor ( var key in motions ) {\r\n\r\n\t\t\t\tvar array = motions[ key ];\r\n\r\n\t\t\t\tarray.sort( function ( a, b ) {\r\n\r\n\t\t\t\t\treturn a.frameNum - b.frameNum;\r\n\r\n\t\t\t\t} );\r\n\r\n\t\t\t\tvar times = [];\r\n\t\t\t\tvar positions = [];\r\n\t\t\t\tvar rotations = [];\r\n\t\t\t\tvar pInterpolations = [];\r\n\t\t\t\tvar rInterpolations = [];\r\n\r\n\t\t\t\tvar basePosition = mesh.skeleton.getBoneByName( key ).position.toArray();\r\n\r\n\t\t\t\tfor ( var i = 0, il = array.length; i < il; i ++ ) {\r\n\r\n\t\t\t\t\tvar time = array[ i ].frameNum / 30;\r\n\t\t\t\t\tvar position = array[ i ].position;\r\n\t\t\t\t\tvar rotation = array[ i ].rotation;\r\n\t\t\t\t\tvar interpolation = array[ i ].interpolation;\r\n\r\n\t\t\t\t\ttimes.push( time );\r\n\r\n\t\t\t\t\tfor ( var j = 0; j < 3; j ++ ) positions.push( basePosition[ j ] + position[ j ] );\r\n\t\t\t\t\tfor ( var j = 0; j < 4; j ++ ) rotations.push( rotation[ j ] );\r\n\t\t\t\t\tfor ( var j = 0; j < 3; j ++ ) pushInterpolation( pInterpolations, interpolation, j );\r\n\r\n\t\t\t\t\tpushInterpolation( rInterpolations, interpolation, 3 );\r\n\r\n\t\t\t\t}\r\n\r\n\t\t\t\tvar targetName = '.bones[' + key + ']';\r\n\r\n\t\t\t\ttracks.push( this._createTrack( targetName + '.position', VectorKeyframeTrack, times, positions, pInterpolations ) );\r\n\t\t\t\ttracks.push( this._createTrack( targetName + '.quaternion', QuaternionKeyframeTrack, times, rotations, rInterpolations ) );\r\n\r\n\t\t\t}\r\n\r\n\t\t\treturn new AnimationClip( '', - 1, tracks );\r\n\r\n\t\t},\r\n\r\n\t\t/**\r\n\t\t * @param {Object} vmd - parsed VMD data\r\n\t\t * @param {SkinnedMesh} mesh - tracks will be fitting to mesh\r\n\t\t * @return {AnimationClip}\r\n\t\t */\r\n\t\tbuildMorphAnimation: function ( vmd, mesh ) {\r\n\r\n\t\t\tvar tracks = [];\r\n\r\n\t\t\tvar morphs = {};\r\n\t\t\tvar morphTargetDictionary = mesh.morphTargetDictionary;\r\n\r\n\t\t\tfor ( var i = 0; i < vmd.metadata.morphCount; i ++ ) {\r\n\r\n\t\t\t\tvar morph = vmd.morphs[ i ];\r\n\t\t\t\tvar morphName = morph.morphName;\r\n\r\n\t\t\t\tif ( morphTargetDictionary[ morphName ] === undefined ) continue;\r\n\r\n\t\t\t\tmorphs[ morphName ] = morphs[ morphName ] || [];\r\n\t\t\t\tmorphs[ morphName ].push( morph );\r\n\r\n\t\t\t}\r\n\r\n\t\t\tfor ( var key in morphs ) {\r\n\r\n\t\t\t\tvar array = morphs[ key ];\r\n\r\n\t\t\t\tarray.sort( function ( a, b ) {\r\n\r\n\t\t\t\t\treturn a.frameNum - b.frameNum;\r\n\r\n\t\t\t\t} );\r\n\r\n\t\t\t\tvar times = [];\r\n\t\t\t\tvar values = [];\r\n\r\n\t\t\t\tfor ( var i = 0, il = array.length; i < il; i ++ ) {\r\n\r\n\t\t\t\t\ttimes.push( array[ i ].frameNum / 30 );\r\n\t\t\t\t\tvalues.push( array[ i ].weight );\r\n\r\n\t\t\t\t}\r\n\r\n\t\t\t\ttracks.push( new NumberKeyframeTrack( '.morphTargetInfluences[' + morphTargetDictionary[ key ] + ']', times, values ) );\r\n\r\n\t\t\t}\r\n\r\n\t\t\treturn new AnimationClip( '', - 1, tracks );\r\n\r\n\t\t},\r\n\r\n\t\t/**\r\n\t\t * @param {Object} vmd - parsed VMD data\r\n\t\t * @return {AnimationClip}\r\n\t\t */\r\n\t\tbuildCameraAnimation: function ( vmd ) {\r\n\r\n\t\t\tfunction pushVector3( array, vec ) {\r\n\r\n\t\t\t\tarray.push( vec.x );\r\n\t\t\t\tarray.push( vec.y );\r\n\t\t\t\tarray.push( vec.z );\r\n\r\n\t\t\t}\r\n\r\n\t\t\tfunction pushQuaternion( array, q ) {\r\n\r\n\t\t\t\tarray.push( q.x );\r\n\t\t\t\tarray.push( q.y );\r\n\t\t\t\tarray.push( q.z );\r\n\t\t\t\tarray.push( q.w );\r\n\r\n\t\t\t}\r\n\r\n\t\t\tfunction pushInterpolation( array, interpolation, index ) {\r\n\r\n\t\t\t\tarray.push( interpolation[ index * 4 + 0 ] / 127 ); // x1\r\n\t\t\t\tarray.push( interpolation[ index * 4 + 1 ] / 127 ); // x2\r\n\t\t\t\tarray.push( interpolation[ index * 4 + 2 ] / 127 ); // y1\r\n\t\t\t\tarray.push( interpolation[ index * 4 + 3 ] / 127 ); // y2\r\n\r\n\t\t\t}\r\n\r\n\t\t\tvar tracks = [];\r\n\r\n\t\t\tvar cameras = vmd.cameras === undefined ? [] : vmd.cameras.slice();\r\n\r\n\t\t\tcameras.sort( function ( a, b ) {\r\n\r\n\t\t\t\treturn a.frameNum - b.frameNum;\r\n\r\n\t\t\t} );\r\n\r\n\t\t\tvar times = [];\r\n\t\t\tvar centers = [];\r\n\t\t\tvar quaternions = [];\r\n\t\t\tvar positions = [];\r\n\t\t\tvar fovs = [];\r\n\r\n\t\t\tvar cInterpolations = [];\r\n\t\t\tvar qInterpolations = [];\r\n\t\t\tvar pInterpolations = [];\r\n\t\t\tvar fInterpolations = [];\r\n\r\n\t\t\tvar quaternion = new Quaternion();\r\n\t\t\tvar euler = new Euler();\r\n\t\t\tvar position = new Vector3();\r\n\t\t\tvar center = new Vector3();\r\n\r\n\t\t\tfor ( var i = 0, il = cameras.length; i < il; i ++ ) {\r\n\r\n\t\t\t\tvar motion = cameras[ i ];\r\n\r\n\t\t\t\tvar time = motion.frameNum / 30;\r\n\t\t\t\tvar pos = motion.position;\r\n\t\t\t\tvar rot = motion.rotation;\r\n\t\t\t\tvar distance = motion.distance;\r\n\t\t\t\tvar fov = motion.fov;\r\n\t\t\t\tvar interpolation = motion.interpolation;\r\n\r\n\t\t\t\ttimes.push( time );\r\n\r\n\t\t\t\tposition.set( 0, 0, - distance );\r\n\t\t\t\tcenter.set( pos[ 0 ], pos[ 1 ], pos[ 2 ] );\r\n\r\n\t\t\t\teuler.set( - rot[ 0 ], - rot[ 1 ], - rot[ 2 ] );\r\n\t\t\t\tquaternion.setFromEuler( euler );\r\n\r\n\t\t\t\tposition.add( center );\r\n\t\t\t\tposition.applyQuaternion( quaternion );\r\n\r\n\t\t\t\tpushVector3( centers, center );\r\n\t\t\t\tpushQuaternion( quaternions, quaternion );\r\n\t\t\t\tpushVector3( positions, position );\r\n\r\n\t\t\t\tfovs.push( fov );\r\n\r\n\t\t\t\tfor ( var j = 0; j < 3; j ++ ) {\r\n\r\n\t\t\t\t\tpushInterpolation( cInterpolations, interpolation, j );\r\n\r\n\t\t\t\t}\r\n\r\n\t\t\t\tpushInterpolation( qInterpolations, interpolation, 3 );\r\n\r\n\t\t\t\t// use the same parameter for x, y, z axis.\r\n\t\t\t\tfor ( var j = 0; j < 3; j ++ ) {\r\n\r\n\t\t\t\t\tpushInterpolation( pInterpolations, interpolation, 4 );\r\n\r\n\t\t\t\t}\r\n\r\n\t\t\t\tpushInterpolation( fInterpolations, interpolation, 5 );\r\n\r\n\t\t\t}\r\n\r\n\t\t\tvar tracks = [];\r\n\r\n\t\t\t// I expect an object whose name 'target' exists under THREE.Camera\r\n\t\t\ttracks.push( this._createTrack( 'target.position', VectorKeyframeTrack, times, centers, cInterpolations ) );\r\n\r\n\t\t\ttracks.push( this._createTrack( '.quaternion', QuaternionKeyframeTrack, times, quaternions, qInterpolations ) );\r\n\t\t\ttracks.push( this._createTrack( '.position', VectorKeyframeTrack, times, positions, pInterpolations ) );\r\n\t\t\ttracks.push( this._createTrack( '.fov', NumberKeyframeTrack, times, fovs, fInterpolations ) );\r\n\r\n\t\t\treturn new AnimationClip( '', - 1, tracks );\r\n\r\n\t\t},\r\n\r\n\t\t// private method\r\n\r\n\t\t_createTrack: function ( node, typedKeyframeTrack, times, values, interpolations ) {\r\n\r\n\t\t\t/*\r\n\t\t\t * optimizes here not to let KeyframeTrackPrototype optimize\r\n\t\t\t * because KeyframeTrackPrototype optimizes times and values but\r\n\t\t\t * doesn't optimize interpolations.\r\n\t\t\t */\r\n\t\t\tif ( times.length > 2 ) {\r\n\r\n\t\t\t\ttimes = times.slice();\r\n\t\t\t\tvalues = values.slice();\r\n\t\t\t\tinterpolations = interpolations.slice();\r\n\r\n\t\t\t\tvar stride = values.length / times.length;\r\n\t\t\t\tvar interpolateStride = interpolations.length / times.length;\r\n\r\n\t\t\t\tvar index = 1;\r\n\r\n\t\t\t\tfor ( var aheadIndex = 2, endIndex = times.length; aheadIndex < endIndex; aheadIndex ++ ) {\r\n\r\n\t\t\t\t\tfor ( var i = 0; i < stride; i ++ ) {\r\n\r\n\t\t\t\t\t\tif ( values[ index * stride + i ] !== values[ ( index - 1 ) * stride + i ] ||\r\n\t\t\t\t\t\t\tvalues[ index * stride + i ] !== values[ aheadIndex * stride + i ] ) {\r\n\r\n\t\t\t\t\t\t\tindex ++;\r\n\t\t\t\t\t\t\tbreak;\r\n\r\n\t\t\t\t\t\t}\r\n\r\n\t\t\t\t\t}\r\n\r\n\t\t\t\t\tif ( aheadIndex > index ) {\r\n\r\n\t\t\t\t\t\ttimes[ index ] = times[ aheadIndex ];\r\n\r\n\t\t\t\t\t\tfor ( var i = 0; i < stride; i ++ ) {\r\n\r\n\t\t\t\t\t\t\tvalues[ index * stride + i ] = values[ aheadIndex * stride + i ];\r\n\r\n\t\t\t\t\t\t}\r\n\r\n\t\t\t\t\t\tfor ( var i = 0; i < interpolateStride; i ++ ) {\r\n\r\n\t\t\t\t\t\t\tinterpolations[ index * interpolateStride + i ] = interpolations[ aheadIndex * interpolateStride + i ];\r\n\r\n\t\t\t\t\t\t}\r\n\r\n\t\t\t\t\t}\r\n\r\n\t\t\t\t}\r\n\r\n\t\t\t\ttimes.length = index + 1;\r\n\t\t\t\tvalues.length = ( index + 1 ) * stride;\r\n\t\t\t\tinterpolations.length = ( index + 1 ) * interpolateStride;\r\n\r\n\t\t\t}\r\n\r\n\t\t\tvar track = new typedKeyframeTrack( node, times, values );\r\n\r\n\t\t\ttrack.createInterpolant = function InterpolantFactoryMethodCubicBezier( result ) {\r\n\r\n\t\t\t\treturn new CubicBezierInterpolation( this.times, this.values, this.getValueSize(), result, new Float32Array( interpolations ) );\r\n\r\n\t\t\t};\r\n\r\n\t\t\treturn track;\r\n\r\n\t\t}\r\n\r\n\t};\r\n\r\n\t// interpolation\r\n\r\n\tfunction CubicBezierInterpolation( parameterPositions, sampleValues, sampleSize, resultBuffer, params ) {\r\n\r\n\t\tInterpolant.call( this, parameterPositions, sampleValues, sampleSize, resultBuffer );\r\n\r\n\t\tthis.interpolationParams = params;\r\n\r\n\t}\r\n\r\n\tCubicBezierInterpolation.prototype = Object.assign( Object.create( Interpolant.prototype ), {\r\n\r\n\t\tconstructor: CubicBezierInterpolation,\r\n\r\n\t\tinterpolate_: function ( i1, t0, t, t1 ) {\r\n\r\n\t\t\tvar result = this.resultBuffer;\r\n\t\t\tvar values = this.sampleValues;\r\n\t\t\tvar stride = this.valueSize;\r\n\t\t\tvar params = this.interpolationParams;\r\n\r\n\t\t\tvar offset1 = i1 * stride;\r\n\t\t\tvar offset0 = offset1 - stride;\r\n\r\n\t\t\t// No interpolation if next key frame is in one frame in 30fps.\r\n\t\t\t// This is from MMD animation spec.\r\n\t\t\t// '1.5' is for precision loss. times are Float32 in Three.js Animation system.\r\n\t\t\tvar weight1 = ( ( t1 - t0 ) < 1 / 30 * 1.5 ) ? 0.0 : ( t - t0 ) / ( t1 - t0 );\r\n\r\n\t\t\tif ( stride === 4 ) { // Quaternion\r\n\r\n\t\t\t\tvar x1 = params[ i1 * 4 + 0 ];\r\n\t\t\t\tvar x2 = params[ i1 * 4 + 1 ];\r\n\t\t\t\tvar y1 = params[ i1 * 4 + 2 ];\r\n\t\t\t\tvar y2 = params[ i1 * 4 + 3 ];\r\n\r\n\t\t\t\tvar ratio = this._calculate( x1, x2, y1, y2, weight1 );\r\n\r\n\t\t\t\tQuaternion.slerpFlat( result, 0, values, offset0, values, offset1, ratio );\r\n\r\n\t\t\t} else if ( stride === 3 ) { // Vector3\r\n\r\n\t\t\t\tfor ( var i = 0; i !== stride; ++ i ) {\r\n\r\n\t\t\t\t\tvar x1 = params[ i1 * 12 + i * 4 + 0 ];\r\n\t\t\t\t\tvar x2 = params[ i1 * 12 + i * 4 + 1 ];\r\n\t\t\t\t\tvar y1 = params[ i1 * 12 + i * 4 + 2 ];\r\n\t\t\t\t\tvar y2 = params[ i1 * 12 + i * 4 + 3 ];\r\n\r\n\t\t\t\t\tvar ratio = this._calculate( x1, x2, y1, y2, weight1 );\r\n\r\n\t\t\t\t\tresult[ i ] = values[ offset0 + i ] * ( 1 - ratio ) + values[ offset1 + i ] * ratio;\r\n\r\n\t\t\t\t}\r\n\r\n\t\t\t} else { // Number\r\n\r\n\t\t\t\tvar x1 = params[ i1 * 4 + 0 ];\r\n\t\t\t\tvar x2 = params[ i1 * 4 + 1 ];\r\n\t\t\t\tvar y1 = params[ i1 * 4 + 2 ];\r\n\t\t\t\tvar y2 = params[ i1 * 4 + 3 ];\r\n\r\n\t\t\t\tvar ratio = this._calculate( x1, x2, y1, y2, weight1 );\r\n\r\n\t\t\t\tresult[ 0 ] = values[ offset0 ] * ( 1 - ratio ) + values[ offset1 ] * ratio;\r\n\r\n\t\t\t}\r\n\r\n\t\t\treturn result;\r\n\r\n\t\t},\r\n\r\n\t\t_calculate: function ( x1, x2, y1, y2, x ) {\r\n\r\n\t\t\t/*\r\n\t\t\t * Cubic Bezier curves\r\n\t\t\t *   https://en.wikipedia.org/wiki/B%C3%A9zier_curve#Cubic_B.C3.A9zier_curves\r\n\t\t\t *\r\n\t\t\t * B(t) = ( 1 - t ) ^ 3 * P0\r\n\t\t\t *      + 3 * ( 1 - t ) ^ 2 * t * P1\r\n\t\t\t *      + 3 * ( 1 - t ) * t^2 * P2\r\n\t\t\t *      + t ^ 3 * P3\r\n\t\t\t *      ( 0 <= t <= 1 )\r\n\t\t\t *\r\n\t\t\t * MMD uses Cubic Bezier curves for bone and camera animation interpolation.\r\n\t\t\t *   http://d.hatena.ne.jp/edvakf/20111016/1318716097\r\n\t\t\t *\r\n\t\t\t *    x = ( 1 - t ) ^ 3 * x0\r\n\t\t\t *      + 3 * ( 1 - t ) ^ 2 * t * x1\r\n\t\t\t *      + 3 * ( 1 - t ) * t^2 * x2\r\n\t\t\t *      + t ^ 3 * x3\r\n\t\t\t *    y = ( 1 - t ) ^ 3 * y0\r\n\t\t\t *      + 3 * ( 1 - t ) ^ 2 * t * y1\r\n\t\t\t *      + 3 * ( 1 - t ) * t^2 * y2\r\n\t\t\t *      + t ^ 3 * y3\r\n\t\t\t *      ( x0 = 0, y0 = 0 )\r\n\t\t\t *      ( x3 = 1, y3 = 1 )\r\n\t\t\t *      ( 0 <= t, x1, x2, y1, y2 <= 1 )\r\n\t\t\t *\r\n\t\t\t * Here solves this equation with Bisection method,\r\n\t\t\t *   https://en.wikipedia.org/wiki/Bisection_method\r\n\t\t\t * gets t, and then calculate y.\r\n\t\t\t *\r\n\t\t\t * f(t) = 3 * ( 1 - t ) ^ 2 * t * x1\r\n\t\t\t *      + 3 * ( 1 - t ) * t^2 * x2\r\n\t\t\t *      + t ^ 3 - x = 0\r\n\t\t\t *\r\n\t\t\t * (Another option: Newton's method\r\n\t\t\t *    https://en.wikipedia.org/wiki/Newton%27s_method)\r\n\t\t\t */\r\n\r\n\t\t\tvar c = 0.5;\r\n\t\t\tvar t = c;\r\n\t\t\tvar s = 1.0 - t;\r\n\t\t\tvar loop = 15;\r\n\t\t\tvar eps = 1e-5;\r\n\t\t\tvar math = Math;\r\n\r\n\t\t\tvar sst3, stt3, ttt;\r\n\r\n\t\t\tfor ( var i = 0; i < loop; i ++ ) {\r\n\r\n\t\t\t\tsst3 = 3.0 * s * s * t;\r\n\t\t\t\tstt3 = 3.0 * s * t * t;\r\n\t\t\t\tttt = t * t * t;\r\n\r\n\t\t\t\tvar ft = ( sst3 * x1 ) + ( stt3 * x2 ) + ( ttt ) - x;\r\n\r\n\t\t\t\tif ( math.abs( ft ) < eps ) break;\r\n\r\n\t\t\t\tc /= 2.0;\r\n\r\n\t\t\t\tt += ( ft < 0 ) ? c : - c;\r\n\t\t\t\ts = 1.0 - t;\r\n\r\n\t\t\t}\r\n\r\n\t\t\treturn ( sst3 * y1 ) + ( stt3 * y2 ) + ttt;\r\n\r\n\t\t}\r\n\r\n\t} );\r\n\r\n\treturn MMDLoader;\r\n\r\n} )();\r\n\r\nexport { MMDLoader };","import { Bone, Color, Matrix4, Mesh, MeshBasicMaterial, Object3D, SkinnedMesh, SphereGeometry, Vector3, Vector4 } from \"three\";\r\n\r\nconst planeBones = [\r\n    \"\",\r\n    \"\",\r\n    \"IK\",\r\n    \"IK\",\r\n    \"IK\",\r\n    \"\",\r\n    \"\",\r\n    \"\",\r\n    \"\",\r\n    \"\",\r\n    \"\",\r\n    \"\",\r\n    \"\",\r\n    \"\",\r\n    \"\",\r\n    \"\",\r\n    \"\",\r\n    \"\",\r\n    \"\",\r\n    \"\",\r\n    \"\",\r\n    \"\",\r\n    \"\",\r\n    \"\",\r\n    \"\",\r\n    \"\",\r\n    \"\",\r\n    \"\",\r\n    \"\",\r\n    \"\",\r\n    \"\",\r\n    \"\",\r\n    \"\",\r\n    \"\",\r\n    \"\",\r\n    \"\",\r\n    \"\",\r\n    \"\",\r\n    \"\",\r\n    \"\",\r\n    \"\",\r\n    \"\",\r\n    \"\",\r\n    \"\",\r\n    \"\",\r\n    \"\",\r\n    \"\",\r\n    \"\",\r\n    \"\",\r\n    \"\",\r\n    \"\",\r\n    \"\",\r\n    \"\",\r\n    \"\"\r\n]\r\n\r\nclass BoneHelper extends Object3D {\r\n    mesh: SkinnedMesh;\r\n    constructor(mesh: SkinnedMesh){\r\n        super();\r\n        this.mesh = mesh;\r\n        this.matrix.copy(mesh.matrixWorld).invert();\r\n        const s = new SphereGeometry( 0.1, 16, 8 );\r\n        const targetSphereMaterial = new MeshBasicMaterial( {\r\n            color: new Color( 0x6464ff ),\r\n            depthTest: false,\r\n            depthWrite: false,\r\n            transparent: true\r\n        } );\r\n        const mmdData = this.mesh.geometry.userData.MMD;\r\n        var j=0;\r\n        // console.log(this.mesh);\r\n        for(const bone of this.mesh.skeleton.bones) {\r\n            const m = new Mesh(s,targetSphereMaterial);\r\n            if(planeBones.indexOf(bone.name) > -1) {\r\n                m.name = \"Helper id:\" + j;\r\n                m.userData = {\r\n                    bone_id: j\r\n                }\r\n                const position = this.getPosition(bone, this.matrix);\r\n                m.position.set(position.x,position.y,position.z);\r\n                this.mesh.add(m);\r\n            }\r\n            j++;\r\n        }\r\n        this.matrixAutoUpdate = true;\r\n        // console.log('children');\r\n        // console.log(this.mesh.children);\r\n        \r\n    }\r\n\r\n    updateMatrixWorld( force:any ){\r\n        this.matrix.copy(this.mesh.matrixWorld).invert();\r\n        var i = 0;\r\n        for (const children of this.mesh.children) {\r\n            if (i === 0){\r\n                i++;\r\n                continue;\r\n            }\r\n            if (children.type === 'Mesh' && children.userData.bone_id != null) {\r\n                const bone: Bone|undefined = this.mesh.skeleton.bones[children.userData.bone_id];\r\n                if (!bone) {\r\n                    continue;\r\n                }\r\n                \r\n                const v = this.getPosition(bone, this.matrix);\r\n                children.position.copy(v);\r\n                children.visible = this.visible;\r\n            }\r\n            i++;\r\n        }\r\n        this.matrix.copy(this.mesh.matrixWorld);\r\n        super.updateMatrixWorld( force );\r\n    }\r\n\r\n    getPosition( bone: Bone, matrixWorldInv: Matrix4 ): Vector3 {\r\n        var vector = new Vector3();\r\n        return vector\r\n            .setFromMatrixPosition( bone.matrixWorld )\r\n            .applyMatrix4( matrixWorldInv );\r\n    }\r\n}\r\nexport default BoneHelper;","\r\nimport React, { useRef, useState, useCallback }  from 'react';\r\nimport { useThree, useFrame } from 'react-three-fiber';\r\nimport { TransformControls } from '@react-three/drei';\r\nimport { SkinnedMesh, Mesh, Raycaster } from 'three';\r\nimport BoneHelper from '../libs/BoneHelper';\r\nimport { useLayoutEffect } from 'react';\r\n\r\nfunction ModelView(props: any) {\r\n    const mesh = useRef<SkinnedMesh>()\r\n    const transform = useRef<TransformControls>()\r\n    const ray = new Raycaster();\r\n    const { scene,mouse,camera } = useThree()\r\n    const [ helper, setHelper ] = useState<BoneHelper|null>(null);\r\n    const [ selectObject, setSelectObject ] = useState(0);\r\n    const handleModelClick = useCallback((e:any)=>{\r\n        if(e.object.type === 'Mesh') {\r\n            setSelectObject( (oldObject: any) => {\r\n                const mesh: Mesh = e.object;\r\n                const bone_id = mesh.userData.bone_id;\r\n                return bone_id;\r\n            });\r\n        }\r\n    },[]);\r\n    useFrame(() => {\r\n        if (mesh.current == null)return;\r\n        if (props.activeModelIndex != props.index)return;\r\n        ray.setFromCamera( mouse, camera );\r\n        const intersects = ray.intersectObjects( mesh.current.children[0].children );\r\n        if(intersects.length > 0) {\r\n            for ( let i = 0; i < intersects.length; i ++ ) {\r\n                const bone_id = intersects[i].object.userData.bone_id;\r\n                const skinnedMesh:SkinnedMesh = mesh.current.children[0] as SkinnedMesh;\r\n                const bone_name = skinnedMesh.geometry.userData.MMD.bones[bone_id].name;\r\n                props.setLabelText(bone_name);\r\n                props.setIsShowLabel(true);\r\n            }\r\n        } else {\r\n            props.setIsShowLabel(false);\r\n        }\r\n    })\r\n    useLayoutEffect(() => {\r\n        if (typeof transform.current !== 'undefined') {\r\n            const controls: any = transform.current\r\n            const callback = (event: any) => {\r\n                if(props.orbit.current){\r\n                    props.orbit.current.enabled = !event.value\r\n                }\r\n            }\r\n            if(controls) {\r\n                if(props.activeModelIndex == props.index) {\r\n                    if(!mesh.current || !mesh.current.children)return;\r\n                    const m:SkinnedMesh | undefined = mesh.current?.children[0] as SkinnedMesh;\r\n                    if(!m)return;\r\n                    controls.attach(m.skeleton.bones[selectObject]);\r\n                    if (props.isShowBoneSelect ) {\r\n                        if(m) {\r\n                            if(helper == null) {\r\n                                const helper = new BoneHelper(m);\r\n                                scene.add(helper);\r\n                                setHelper(helper);\r\n                            } else {\r\n                                helper.visible = true;\r\n                            }\r\n                        }\r\n                    } else {\r\n                        if(helper){\r\n                            helper.visible = false;\r\n                        }\r\n                    }\r\n                    if(props.controlMode != \"\") {\r\n                        controls.setMode(props.controlMode);\r\n                    } else {\r\n                        controls.detach();\r\n                    }\r\n\r\n                } else {\r\n                    controls.detach();\r\n                    if(helper != null) {\r\n                        helper.visible = false;\r\n                    }\r\n                }\r\n                controls.addEventListener(\"dragging-changed\", callback);\r\n                return () => {\r\n                    controls.removeEventListener(\"dragging-changed\", callback);\r\n                }\r\n            }\r\n        }\r\n    })\r\n\r\n    return (\r\n        <>\r\n            {props.activeModelIndex == props.index \r\n            ?   <TransformControls \r\n                    ref={transform} \r\n                    enabled={true}\r\n                    >\r\n                    <mesh ref={mesh}\r\n                    \r\n                    onClick={handleModelClick}>\r\n                        <primitive \r\n                            object={props.modelClass.mesh} \r\n                            dispose={null} \r\n                            scale={[0.5 ,0.5, 0.5]} \r\n                            position={props.position}/>\r\n                    </mesh>\r\n                </TransformControls> \r\n            :   <mesh ref={mesh}\r\n                    onClick={handleModelClick}>\r\n                        <primitive \r\n                            object={props.modelClass.mesh} \r\n                            dispose={null} \r\n                            scale={[0.5 ,0.5, 0.5]} \r\n                            position={props.position}/>\r\n                </mesh>}\r\n        </>\r\n    );\r\n}\r\n\r\nexport default ModelView;\r\n","import React, { useMemo, useRef, useEffect } from 'react'\r\nimport styled, { createGlobalStyle, css } from 'styled-components';\r\nexport default function Status(props: any) {\r\n  return (\r\n    <>\r\n      <UpperLeft style={{top:(props.top + 5),left:(props.left + 5)}}>\r\n        {props.text}\r\n      </UpperLeft>\r\n    </>\r\n  )\r\n}\r\n\r\nconst base = css`\r\n  position: absolute;\r\n  pointer-events: none;\r\n  user-select: none;\r\n  color: black;\r\n  background-color: white;\r\n  z-index:100000;\r\n`\r\n\r\nconst UpperLeft = styled.div`\r\n  ${base}\r\n  top: 100px;\r\n  left: 10px;\r\n  font-size: 2em;\r\n  pointer-events: all;\r\n  @media only screen and (max-width: 900px) {\r\n    font-size: 1.5em;\r\n  }\r\n`\r\n","import { createContext, Dispatch, SetStateAction } from \"react\";\r\nimport { ModelClass } from \"../classes/ModelClass\";\r\n\r\nconst project: { \r\n        dirHandle: any; \r\n        setDirHandle: Dispatch<SetStateAction<undefined>>\r\n        models: ModelClass[],\r\n        setModels: Dispatch<SetStateAction<ModelClass[]>>\r\n        activeModelIndex: number,\r\n        setactiveModelIndex: Dispatch<SetStateAction<number>>,\r\n        editMode:string,\r\n        setEditMode: Dispatch<SetStateAction<string>>,\r\n        fov:number,\r\n        setFov: Dispatch<SetStateAction<number>>,\r\n    } = {\r\n        dirHandle: null,\r\n        setDirHandle: () => {},\r\n        models: [],\r\n        setModels: () => {},\r\n        activeModelIndex: -1,\r\n        setactiveModelIndex: () => {},\r\n        editMode: \"model\",\r\n        setEditMode: () => {},\r\n        fov: 30,\r\n        setFov: () => {},\r\n};\r\n\r\nconst ProjectContext = createContext(project);\r\nexport default ProjectContext;","import { createStyles, Fab, makeStyles, Theme } from '@material-ui/core';\r\nimport React, { useMemo, useRef, useEffect, createRef } from 'react';\r\nimport SearchIcon from '@material-ui/icons/Search';\r\nimport PanToolIcon from '@material-ui/icons/PanTool';\r\nimport { Object3DNode, Overwrite, useThree, } from 'react-three-fiber';\r\nimport { OrbitControls } from '@react-three/drei';\r\nimport { Matrix4, PerspectiveCamera, Vector2, Vector3 } from 'three';\r\n\r\nconst useStyles = makeStyles((theme: Theme) =>\r\n  createStyles({\r\n    position: {\r\n      position: 'absolute',\r\n      zIndex: 1,\r\n      right: 10\r\n    },\r\n  }),\r\n);\r\n\r\nexport default function ActionBUttons(props: any) {\r\n  var panStart = new Vector2();\r\n  var panEnd = new Vector2();\r\n  var panDelta = new Vector2();\r\n  const classes = useStyles();\r\n  const refZoom = useRef() as React.RefObject<HTMLButtonElement>;\r\n  const refTransform = useRef() as React.RefObject<HTMLButtonElement>;\r\n  const onMouseDownZoom = (event: React.MouseEvent<HTMLButtonElement, MouseEvent>) => {\r\n    refZoom.current?.requestPointerLock();\r\n  }\r\n  const onMouseUpZoom = (event: any) => {\r\n    window.document.exitPointerLock();\r\n  }\r\n\r\n  const onMouseMoveZoom = (event: React.MouseEvent<HTMLButtonElement, MouseEvent>) => {\r\n    if(!window.document.pointerLockElement)return;\r\n    const orbit = props.orbit as React.MutableRefObject<Overwrite<Object3DNode<OrbitControls, typeof OrbitControls>, {\r\n      target?: Vector3 | [x: number, y: number, z: number] | undefined;\r\n  }> | undefined>;\r\n    if(orbit) {\r\n      const camera = orbit.current?.object;\r\n      if (camera) {\r\n        camera.translateZ(event.movementY);\r\n      }\r\n    }\r\n  }\r\n  const onMouseDownTransform = (event: React.MouseEvent<HTMLButtonElement, MouseEvent>) => {\r\n    refTransform.current?.requestPointerLock();\r\n    panStart.set( event.clientX, event.clientY );\r\n  }\r\n  const onMouseUpTransform = (event: any) => {\r\n    window.document.exitPointerLock();\r\n  }\r\n  const onMouseMoveTransform = (event: React.MouseEvent<HTMLButtonElement, MouseEvent>) => {\r\n    if(!window.document.pointerLockElement)return;\r\n    const orbit = props.orbit as React.MutableRefObject<Overwrite<Object3DNode<OrbitControls, typeof OrbitControls>, {\r\n      target?: Vector3 | [x: number, y: number, z: number] | undefined;\r\n  }> | undefined>;\r\n    if(orbit) {\r\n      const orbitControl = orbit.current as OrbitControls;\r\n      const camera = orbitControl.object as PerspectiveCamera;\r\n      const element = orbitControl.domElement as HTMLElement;\r\n      const panSpeed = orbitControl.panSpeed as number;\r\n      \r\n      if (orbitControl && orbitControl.object) {\r\n        panEnd.set( panStart.x + event.movementX, panStart.y + event.movementY );\r\n        panDelta.subVectors( panEnd, panStart ).multiplyScalar( panSpeed );\r\n        const target = orbitControl.target as Vector3;\r\n        var offset = new Vector3();\r\n        if ( target ) {\r\n          var position = camera.position;\r\n          offset.copy( position ).sub( target );\r\n          var targetDistance = offset.length();\r\n          targetDistance *= Math.tan( ( camera.fov / 2 ) * Math.PI / 180.0 );\r\n          var panOffset = new Vector3();\r\n          panOffset.add(panLeft( 2 * panDelta.x * targetDistance / element.clientWidth, camera.matrix ));\r\n          panOffset.add(panUp( 2 * panDelta.y * targetDistance / element.clientHeight, camera.matrix));\r\n          panStart.copy( panEnd );\r\n          target.add( panOffset );\r\n          var position = orbitControl.object.position;\r\n          position.copy( target ).add( offset );\r\n        }\r\n      }\r\n    }\r\n  }\r\n\r\n  const panLeft = ( distance: number, objectMatrix: Matrix4 ):Vector3 => {\r\n      var v = new Vector3();\r\n\t\t\tv.setFromMatrixColumn( objectMatrix, 0 );\r\n\t\t\tv.multiplyScalar( - distance );\r\n      return v;\r\n\t};\r\n\r\n\tconst panUp = ( distance: number, objectMatrix: Matrix4):Vector3 => {\r\n\t\tvar v = new Vector3();\r\n    v.setFromMatrixColumn( objectMatrix, 1 );\r\n\t\tv.multiplyScalar( distance );\r\n    return v;\r\n\t}\r\n\r\n  return (\r\n    <>\r\n      <Fab\r\n        ref={refZoom}\r\n        size=\"small\" \r\n        color=\"primary\"\r\n        className={classes.position}\r\n        style={{top:50}}\r\n        onMouseDown={onMouseDownZoom}\r\n        onMouseUp={onMouseUpZoom}\r\n        onMouseMove={onMouseMoveZoom}\r\n        >\r\n        <SearchIcon />\r\n      </Fab>\r\n      <Fab\r\n        ref={refTransform}\r\n        size=\"small\" \r\n        color=\"primary\"\r\n        className={classes.position}\r\n        style={{top:100}}\r\n        onMouseDown={onMouseDownTransform}\r\n        onMouseUp={onMouseUpTransform}\r\n        onMouseMove={onMouseMoveTransform}\r\n        >\r\n        <PanToolIcon />\r\n      </Fab>\r\n    </>\r\n  )\r\n}","import { OrbitControls, OrthographicCamera, Stats, useCamera } from \"@react-three/drei\";\r\nimport { AnyMxRecord } from \"dns\";\r\nimport React, { createRef, Suspense, useContext, useRef, useState } from \"react\";\r\nimport { useEffect } from \"react\";\r\nimport { useMemo } from \"react\";\r\nimport { Canvas, createPortal, SceneProps, useFrame, useThree } from \"react-three-fiber\";\r\nimport { Matrix4,  Mesh,  PerspectiveCamera,  Raycaster,  Scene, Sprite, SpriteMaterial, Texture, Vector2, Vector3 } from \"three\";\r\nimport { ModelClass } from \"../classes/ModelClass\";\r\nimport Label from \"./Label\";\r\nimport ModelView from \"./ModelView\";\r\nimport Status from \"./Status\";\r\nimport '../App.css'\r\nimport { useCallback } from \"react\";\r\nimport ProjectContext from \"../contexts/ProjectContext\";\r\nimport ActionButtons from './ActionButtons';\r\nimport { Button } from \"@material-ui/core\";\r\n\r\nfunction Camera(props:any) {\r\n    const ref = useRef<PerspectiveCamera>()\r\n    const { setDefaultCamera } = useThree()\r\n\r\n    useEffect(() => {\r\n        if(ref && ref.current) {\r\n            let camera = ref.current;\r\n            if(camera.fov != props.fov){\r\n                camera.fov = props.fov;\r\n                camera.updateProjectionMatrix();\r\n            }\r\n            setDefaultCamera(camera);\r\n        }\r\n    })\r\n    return <perspectiveCamera ref={ref} position={[0,10,30]} />\r\n}\r\n\r\nfunction MainView(props:any){\r\n    const [ labelP, setLabelP ] = useState<[number,number]>([0,0]);\r\n    const [ labelText, setLabelText ] = useState(\"\")\r\n    const [ isShowLabel, setIsShowLabel] = useState(true);\r\n    const orbit = useRef<OrbitControls>();\r\n    const onMouseMove = useCallback((e: React.MouseEvent<HTMLDivElement, MouseEvent>)=>{\r\n        setLabelP([e.clientY,e.clientX]);\r\n    },[]);\r\n    const projectContext = useContext(ProjectContext);\r\n\r\n    return (\r\n        <div>\r\n            {\r\n                isShowLabel \r\n                ? <Status top={labelP[0]} left={labelP[1]} text={labelText}/>\r\n                : null \r\n            }\r\n            <ActionButtons orbit={orbit} height={350} />\r\n            <Canvas\r\n            className=\"mainView\"\r\n            onMouseMove={onMouseMove}\r\n            style={{backgroundColor:\"white\",height:\"350px\"}}\r\n            colorManagement={false}\r\n            >\r\n                <Camera fov={projectContext.fov} />\r\n                <Stats\r\n                    showPanel={0} // Start-up panel (default=0)\r\n                    className={\"stats\"}\r\n                />\r\n                <directionalLight \r\n                      intensity={0.9}\r\n                      position={[-0.5, -1, 0.5]}\r\n                      castShadow={true}\r\n                />\r\n                <Suspense fallback={null}>\r\n                {projectContext.models.map((model:ModelClass,index: any) => {\r\n                    // CanvasContext\r\n                    // https://spectrum.chat/react-three-fiber/general/using-usecontext-hook-within-canvas~41e3bc4a-28c2-4318-930c-df8be8d3a014\r\n                    return(\r\n                    <ModelView \r\n                        {...props}\r\n                        key={index}\r\n                        index={index}\r\n                        modelClass={model} \r\n                        position={[0,0,0]}\r\n                        activeModelIndex={projectContext.activeModelIndex}\r\n                        setLabelText={setLabelText}\r\n                        setIsShowLabel={setIsShowLabel}\r\n                        orbit={orbit}\r\n                    />\r\n                )})}\r\n                </Suspense>\r\n                <OrbitControls ref={orbit} />\r\n                <gridHelper />\r\n            </Canvas>\r\n            <div style={{height:\"32px\",width:\"100%\"}}>\r\n                {projectContext.editMode === 'model' ? (\r\n                    <Button size=\"small\" onClick={() => {projectContext.setEditMode('camera')}}>\r\n                        \r\n                    </Button>\r\n                ): (\r\n                    <Button size=\"small\" onClick={() => {projectContext.setEditMode('model')}}>\r\n                        \r\n                    </Button>\r\n                )}\r\n            </div>\r\n        </div>\r\n    );\r\n}\r\n\r\nexport default MainView;","import { Button, ButtonGroup } from '@material-ui/core';\r\nimport React, { useEffect, useState, useRef, CSSProperties } from 'react';\r\n\r\ntype Props = {\r\n    controlMode: string,\r\n    setControlMode: React.Dispatch<React.SetStateAction<string>>,\r\n    isShowBoneSelect: boolean,\r\n    setIsShowBoneSelect: React.Dispatch<React.SetStateAction<boolean>>,\r\n}\r\n\r\nconst BoneControl:React.VFC<Props> = props => {\r\n    const setControl = (mode:string) => {\r\n        props.setControlMode(mode);\r\n    }\r\n    const toggleBoneSelect = () => {\r\n        if ( props.isShowBoneSelect ){\r\n            props.setIsShowBoneSelect(false);\r\n        } else {\r\n            props.setIsShowBoneSelect(true);\r\n        }\r\n    }\r\n    const toggleRotate = () => {\r\n        if (props.controlMode === 'rotate') {\r\n            props.setControlMode(\"\");\r\n        } else {\r\n            props.setControlMode(\"rotate\");\r\n        }\r\n    }\r\n    const toggleTransfer = () => {\r\n        if (props.controlMode === 'translate') {\r\n            props.setControlMode(\"\");\r\n        } else {\r\n            props.setControlMode(\"translate\");\r\n        }\r\n    }\r\n    return (\r\n        <div style={{textAlign: \"center\", padding:\"5px\"}}>\r\n            <p style={{fontSize:20,margin:\"0px 0px 10px 0px\"}}></p>\r\n            <ButtonGroup fullWidth aria-label=\"button group\">\r\n                <ButtononClick={toggleBoneSelect}></Button>\r\n                <ButtononClick={toggleRotate}></Button>\r\n                <ButtononClick={toggleTransfer}></Button>\r\n            </ButtonGroup>\r\n        </div>\r\n      );\r\n}\r\nexport default BoneControl;","import React, { useContext, useEffect, useState } from 'react';\r\nimport FormControl from '@material-ui/core/FormControl';\r\nimport Select from '@material-ui/core/Select';\r\nimport {  createStyles,  InputLabel, makeStyles, Slider, Theme } from '@material-ui/core';\r\nimport { SkinnedMesh } from 'three';\r\nimport ProjectContext from '../contexts/ProjectContext';\r\n\r\nconst useStyles = makeStyles((theme: Theme) =>\r\n  createStyles({\r\n    formControl: {\r\n      margin: theme.spacing(1),\r\n      minWidth: 120,\r\n    },\r\n    selectEmpty: {\r\n      marginTop: theme.spacing(2),\r\n    },\r\n  }),\r\n);\r\n\r\ntype Props = {\r\n    label: string;\r\n    morphType: number;\r\n    morphs:any;\r\n    handleChange: (event: any, newValue: number | number[],morphs_array_num: number, selectValue: number ) => void;\r\n    morphSliders: number[];\r\n}\r\nfunction MorphControl(props : Props) {\r\n    const classes = useStyles();\r\n    const [selectValue, setSelectValue] = useState(-1);\r\n    function onChangeSelect(event: React.ChangeEvent<{ name?: string; value: unknown }>){\r\n        const n = event.target.value;\r\n        if (typeof n === 'string') {\r\n            props.handleChange(null,0,props.morphType,selectValue);\r\n            setSelectValue(Number(n));\r\n        }\r\n    }\r\n    return(\r\n        <FormControl variant=\"filled\" className={classes.formControl}>\r\n            <InputLabel id=\"label\">{props.label}</InputLabel>\r\n            <Select\r\n            labelId=\"label\"\r\n            style={{minWidth: 150}}\r\n            onChange={onChangeSelect}\r\n            value={selectValue}\r\n            native>\r\n                <option key={-1} value={-1}></option>\r\n                {props.morphs.map((value: any,index: number) => {\r\n                    return(\r\n                    <option key={index} value={value.id}>{value.name}</option>\r\n                )})}\r\n            </Select>\r\n            <Slider \r\n                value={props.morphSliders[props.morphType]}\r\n                onChange={(e,newValue) => props.handleChange(e,newValue,props.morphType,selectValue)}\r\n                aria-labelledby=\"continuous-slider\"\r\n                step={0.001}\r\n                min={0}\r\n                max={1}\r\n            />\r\n        </FormControl>\r\n    );\r\n}\r\n\r\nfunction FaceControl(props:any){\r\n    const [morphs, setMorphs] = useState([[],[],[],[]]);\r\n    const [morphSliders, setMorphSliders] = useState([0, 0, 0, 0]);\r\n    const projectContext = useContext(ProjectContext);\r\n\r\n    useEffect(() => {\r\n        if(projectContext.activeModelIndex === -1)return;\r\n        if(\r\n            (projectContext.models.length < projectContext.activeModelIndex) || (!projectContext.models[projectContext.activeModelIndex])\r\n            ) {\r\n            return;\r\n        }\r\n        const mesh:SkinnedMesh | null = projectContext.models[projectContext.activeModelIndex].mesh;\r\n        if(!mesh || !mesh.morphTargetInfluences){\r\n            return;\r\n        }\r\n        const morphs = mesh.geometry.userData.MMD.morphs;\r\n        let morphs_array:any = [[],[],[],[]];\r\n        var i=0;\r\n        for (const m of morphs) {\r\n            const morph = {\r\n                id:i,\r\n                name:m.name\r\n            }\r\n            if (m.panel) {\r\n                //pmx\r\n                if(m.panel < 1 || m.panel > 4) {\r\n                    i++;\r\n                    continue;\r\n                }\r\n                morphs_array[m.panel - 1].push(morph);\r\n            } else {\r\n                //pmd\r\n                if(m.type < 1 || m.type > 4) {\r\n                    i++;\r\n                    continue;\r\n                }\r\n                morphs_array[m.type - 1].push(morph);\r\n            }\r\n            i++;\r\n        }\r\n        setMorphs(morphs_array)\r\n    },[projectContext.models,projectContext.activeModelIndex])\r\n\r\n    const handleChange = (event: any, newValue: number | number[],morphs_array_num: number,selectValue: number ) => {\r\n        const mesh: SkinnedMesh | null = projectContext.models[projectContext.activeModelIndex].mesh;\r\n        if(!mesh || !mesh.morphTargetInfluences){\r\n            console.error(\"meshnullmorphTargetInfluencesnulld\")\r\n            return;\r\n        }\r\n        mesh.morphTargetInfluences[selectValue] = newValue as number;\r\n        const newMprphSliders = morphSliders.slice();\r\n        newMprphSliders[morphs_array_num] = newValue as number;\r\n        setMorphSliders(newMprphSliders);\r\n    };\r\n    return (\r\n        <div style={{textAlign: \"center\"}}>\r\n            <p style={{fontSize:20,margin:\"5px 0px 0px 0px\"}}></p>\r\n            <div style={{padding:\"0px 10px 10px 10px\"}}>\r\n                <MorphControl label=\"\" morphs={morphs[0]} morphType={0} handleChange={handleChange} morphSliders={morphSliders} />\r\n                <MorphControl label=\"\" morphs={morphs[1]} morphType={1} handleChange={handleChange} morphSliders={morphSliders} />\r\n            </div>\r\n            <div style={{padding:\"0px 10px 10px 10px\"}}>\r\n                <MorphControl label=\"\" morphs={morphs[2]} morphType={2} handleChange={handleChange} morphSliders={morphSliders} />\r\n                <MorphControl label=\"\" morphs={morphs[3]} morphType={3} handleChange={handleChange} morphSliders={morphSliders} />\r\n            </div>\r\n        </div>\r\n      );\r\n}\r\nexport default FaceControl;","import React, { RefObject, useRef } from 'react';\r\nimport { makeStyles, Theme, createStyles } from '@material-ui/core/styles';\r\nimport Button from '@material-ui/core/Button';\r\nimport List from '@material-ui/core/List';\r\nimport ListItem from '@material-ui/core/ListItem';\r\nimport ListItemText from '@material-ui/core/ListItemText';\r\nimport DialogTitle from '@material-ui/core/DialogTitle';\r\nimport DialogContent from '@material-ui/core/DialogContent';\r\nimport DialogActions from '@material-ui/core/DialogActions';\r\nimport Dialog from '@material-ui/core/Dialog';\r\nimport RadioGroup from '@material-ui/core/RadioGroup';\r\nimport Radio from '@material-ui/core/Radio';\r\nimport FormControlLabel from '@material-ui/core/FormControlLabel';\r\nimport { Canvas, Image, loadImage } from 'canvas';\r\n\r\nconst options = [\r\n  'None',\r\n  'Atria',\r\n  'Callisto',\r\n  'Dione',\r\n  'Ganymede',\r\n  'Hangouts Call',\r\n  'Luna',\r\n  'Oberon',\r\n  'Phobos',\r\n  'Pyxis',\r\n  'Sedna',\r\n  'Titania',\r\n  'Triton',\r\n  'Umbriel',\r\n];\r\nconst useStyles = makeStyles((theme: Theme) =>\r\n  createStyles({\r\n    root: {\r\n      width: '100%',\r\n      maxWidth: 360,\r\n      backgroundColor: theme.palette.background.paper,\r\n    },\r\n    paper: {\r\n      width: '80%',\r\n      maxHeight: 435,\r\n    },\r\n  }),\r\n);\r\nexport interface ConfirmationDialogRawProps {\r\n  id: string;\r\n  keepMounted: boolean;\r\n  value: Image | undefined;\r\n  open: boolean;\r\n  onClose: (value?: string) => void;\r\n}\r\n\r\nfunction PoseNetPreview(props: ConfirmationDialogRawProps) {\r\n    const classes = useStyles();\r\n    const canvasRef = useRef(null);\r\n    const content = useRef();\r\n    const { onClose, value: valueProp, open, ...other } = props;\r\n    const [value, setValue] = React.useState(valueProp);\r\n    const radioGroupRef = React.useRef<HTMLElement>(null);\r\n\r\n    const getContext = (): CanvasRenderingContext2D | null => {\r\n        const canvas: any = canvasRef.current;\r\n        if(canvas) {\r\n            return canvas.getContext('2d');\r\n        }\r\n        return null;\r\n        \r\n    };\r\n    React.useEffect(() => {\r\n        const ctx = getContext();\r\n        if(ctx && props.value) {\r\n            const d = content.current as unknown as HTMLDivElement;\r\n            const canvas = canvasRef.current as unknown as HTMLCanvasElement;\r\n            const image = props.value as unknown as CanvasImageSource;\r\n            const imageWidth = image.width as number;\r\n            const imageHeight = image.height as number;\r\n            canvas.width = d.clientWidth;\r\n            var scale = canvas.width / imageWidth;\r\n            canvas.height = imageHeight * scale;\r\n            // const scale = canvas.height / imageHeight;\r\n            ctx.setTransform(scale, 0, 0, scale, 0, 0);\r\n            // @ts-ignore\r\n            ctx.drawImage(image,0,0);\r\n        }\r\n        \r\n        if (!open) {\r\n            setValue(valueProp);\r\n        }\r\n    }, [valueProp, open]);\r\n\r\n  const handleEntering = () => {\r\n    if (radioGroupRef.current != null) {\r\n      radioGroupRef.current.focus();\r\n    }\r\n  };\r\n\r\n  const handleCancel = () => {\r\n    onClose();\r\n  };\r\n\r\n  const handleOk = () => {\r\n    // onClose(value);\r\n  };\r\n\r\n\r\n  return (\r\n    <Dialog\r\n      disableBackdropClick\r\n      disableEscapeKeyDown\r\n      maxWidth=\"lg\"\r\n      onEntering={handleEntering}\r\n      aria-labelledby=\"confirmation-dialog-title\"\r\n      open={open}\r\n      {...other}\r\n    >\r\n      <DialogTitle id=\"confirmation-dialog-title\">PoseNet</DialogTitle>\r\n      <DialogContent dividers={true} ref={content}>\r\n         <canvas ref={canvasRef}>\r\n\r\n         </canvas>\r\n      </DialogContent>\r\n      <DialogActions>\r\n        <Button autoFocus onClick={handleCancel} color=\"primary\">\r\n          Cancel\r\n        </Button>\r\n        <Button onClick={handleOk} color=\"primary\">\r\n          Ok\r\n        </Button>\r\n      </DialogActions>\r\n    </Dialog>\r\n  );\r\n}\r\nexport default PoseNetPreview;","import { SkinnedMesh } from 'three';\r\nexport class ModelClass{\r\n    public path: string | null;\r\n    public mesh: SkinnedMesh | null;\r\n    public modelName: string | null;\r\n    public comment: string | null;\r\n    constructor(){\r\n        this.path = null;\r\n        this.mesh = null;\r\n        this.modelName = null;\r\n        this.comment = null;\r\n    }\r\n}\r\n","import React, { useContext, useState } from 'react';\r\nimport DialogTitle from '@material-ui/core/DialogTitle';\r\nimport DialogContent from '@material-ui/core/DialogContent';\r\nimport Dialog from '@material-ui/core/Dialog';\r\nimport { Backdrop, Button, CircularProgress, DialogActions, Link, List, ListItem, ListItemText, Typography } from '@material-ui/core';\r\nimport ProjectContext from '../contexts/ProjectContext';\r\nimport { ModelClass } from '../classes/ModelClass';\r\nimport { MMDLoader } from '../libs/MMDLoader';\r\n\r\nexport interface SelectLoadModelDialogProps {\r\n    values: {\r\n        file: File;\r\n        path: string;\r\n        rootDirHandle: any;\r\n    }[];\r\n    open: boolean;\r\n    setOpen: (value?: any) => void;\r\n}\r\n\r\nfunction SelectLoadModelDialog(props: SelectLoadModelDialogProps) {\r\n    const [progressOpen,setProgressOpen] = useState(false);\r\n    const projectContext = useContext(ProjectContext);\r\n\r\n    const handleClose = () => {\r\n        props.setOpen(false);\r\n    }\r\n\r\n    const handleListItemClick = (e: React.MouseEvent<HTMLDivElement, MouseEvent>, index: number) => {\r\n        handleClose();\r\n        setProgressOpen(true);\r\n        const loader = new MMDLoader();\r\n        // @ts-ignore\r\n        loader.loadFile(props.values[index].file, props.values[index].rootDirHandle, (mesh: SkinnedMesh) => {\r\n            const m:ModelClass = new ModelClass();\r\n            m.mesh = mesh;\r\n            const comment = \":\\n\\n\" + mesh.geometry.userData.MMD.comment;\r\n            m.comment = comment;\r\n            m.modelName = projectContext.models.length + ':' + mesh.geometry.userData.MMD.modelName;\r\n            const newModels = [...projectContext.models,m];\r\n            const newActiveId = projectContext.activeModelIndex + 1;\r\n            alert(m.comment);\r\n            projectContext.setModels(newModels);\r\n            projectContext.setactiveModelIndex(newActiveId);\r\n            setProgressOpen(false);\r\n        });\r\n    }\r\n\r\n    return (\r\n        <>\r\n            <Backdrop open={progressOpen} style={{zIndex: 10000 ,color: '#fff',}}>\r\n                <CircularProgress color=\"inherit\" />\r\n            </Backdrop>\r\n            <Dialog\r\n                disableBackdropClick\r\n                disableEscapeKeyDown\r\n                keepMounted\r\n                maxWidth=\"lg\"\r\n                aria-labelledby=\"confirmation-dialog-title\"\r\n                open={props.open}\r\n            >\r\n                <DialogTitle id=\"confirmation-dialog-title\"></DialogTitle>\r\n                <DialogContent dividers>\r\n                    <List component=\"div\" role=\"list\">\r\n                        {\r\n                            props.values.map((value,index) => {\r\n                                return(\r\n                                    <ListItem key={index} button divider role=\"listitem\" onClick={(event) => handleListItemClick(event, index)}>\r\n                                        <ListItemText primary={value.path} />\r\n                                    </ListItem>\r\n                                )\r\n                            })\r\n                        }\r\n                    </List>\r\n                </DialogContent>\r\n                <DialogActions>\r\n                    <Button onClick={handleClose} color=\"secondary\">\r\n                        Cancel\r\n                    </Button>\r\n                </DialogActions>\r\n            </Dialog>\r\n        </>\r\n    );\r\n}\r\nexport default SelectLoadModelDialog;","import React, { useContext, useEffect, useState } from 'react';\r\nimport { ModelClass } from '../classes/ModelClass';\r\nimport { MMDLoader } from '../libs/MMDLoader'\r\nimport FormControl from '@material-ui/core/FormControl';\r\nimport Select from '@material-ui/core/Select';\r\nimport { Button, createStyles, makeStyles, Theme } from '@material-ui/core';\r\nimport { SkinnedMesh } from 'three';\r\nimport * as posenet from '@tensorflow-models/posenet';\r\nimport * as tf from '@tensorflow/tfjs';\r\nimport { createCanvas, createImageData, Image, ImageData, loadImage } from 'canvas';\r\nimport PoseNetPreview from './PoseNetPreview';\r\nimport ProjectContext from '../contexts/ProjectContext';\r\nimport SelectLoadModelDialog from './SelectLoadModelDIalog';\r\n\r\nconst useStyles = makeStyles((theme: Theme) =>\r\n    createStyles({\r\n        formControl: {\r\n            margin: theme.spacing(1),\r\n            minWidth: 200,\r\n        },\r\n            selectEmpty: {\r\n            marginTop: theme.spacing(2),\r\n        },\r\n    }),\r\n);\r\n\r\nfunction ModelControl(props:any){\r\n\r\n    const classes = useStyles();\r\n\r\n    const projectContext = useContext(ProjectContext);\r\n\r\n    function onChangeModelSelect(event: React.ChangeEvent<{ name?: string; value: unknown }>){\r\n        projectContext.setactiveModelIndex(event.target.value as number);\r\n    }\r\n\r\n    const [open, setOpen] = React.useState(false);\r\n    const [value, setValue] = React.useState<Image>();\r\n\r\n    const [selectLoadModelDialogOpen, setSelectLoadModelDialogOpen] = useState(false);\r\n    const [selectLoadModelDialogValue, setSelectLoadModelDialogValue] = useState<{\r\n        file: File;\r\n        path: string;\r\n        rootDirHandle: any;\r\n    }[]>([]);\r\n\r\n    \r\n\r\n    async function getFilesFromDir(dirHandle: any,path: string):Promise<{file:File,path:string,rootDirHandle:any}[]> {\r\n        var files:{file:File,path:string,rootDirHandle:any}[] = [];\r\n        for await(var [name, entry] of dirHandle) {\r\n            if (entry.kind === 'file') {\r\n                var extensionIndex = name.lastIndexOf( '.' );\r\n                const extension = extensionIndex < 0 ? '' : name.slice( extensionIndex + 1 ).toLowerCase();\r\n\t\t\t\tif(extension === 'pmx' || extension === 'pmd') {\r\n                    var file:File = await entry.getFile();\r\n\t\t\t\t\tfiles.push({file:file,path:path + name,rootDirHandle:dirHandle});\r\n\t\t\t\t}\r\n            } else if (entry.kind === 'directory') {\r\n                const array = await getFilesFromDir(entry,entry.name + '\\\\');\r\n                files = files.concat(array);\r\n            }\r\n        }\r\n        return files;\r\n    }\r\n\r\n    async function onLoadModel(){\r\n        try {\r\n            // @ts-ignore\r\n            const dirHandle = await window.showDirectoryPicker();\r\n            const array = await getFilesFromDir(dirHandle,\"\");\r\n            setSelectLoadModelDialogValue(array);\r\n            setSelectLoadModelDialogOpen(true);\r\n        } catch(e) {\r\n            console.error(e);\r\n        }\r\n    }\r\n\r\n    function onDeleteModel(){\r\n        if(projectContext.activeModelIndex === -1){\r\n            console.warn('')\r\n            return;\r\n        }\r\n        const newModels = projectContext.models.filter((value, index) => index != projectContext.activeModelIndex);\r\n        const newActiveId = newModels.length - 1;\r\n        projectContext.setModels(newModels);\r\n        projectContext.setactiveModelIndex(newActiveId);\r\n    }\r\n\r\n    const handlePoseNetPreviewClose = (newValue?: string) => {\r\n        setOpen(false);\r\n      };\r\n\r\n    async function setPosenet(){\r\n        // @ts-ignore\r\n        let fileHandle;\r\n        // @ts-ignore\r\n        [fileHandle] = await window.showOpenFilePicker();\r\n        var file = await fileHandle.getFile();\r\n        const base64Str = await readFileAsDataURL(file);\r\n        if(typeof base64Str === \"string\"){\r\n            const img = await loadImage(base64Str);\r\n            // console.log(img);\r\n            // const imageData = createImageData(img.width, img.height);\r\n            const canvas = createCanvas(img.width, img.height);\r\n            const ctx = canvas.getContext('2d');\r\n            ctx.drawImage(img,0,0);\r\n            const input = tf.browser.fromPixels(ctx.getImageData(0,0,img.width,img.height));\r\n            const net = await posenet.load();\r\n            const pose = await net.estimateSinglePose(input,{\r\n                flipHorizontal: false\r\n            });\r\n            // console.log(props.models[props.activeModelIndex]);\r\n            const mesh:SkinnedMesh = props.models[props.activeModelIndex].mesh;\r\n            for(var keypoint of pose.keypoints){\r\n                console.log(keypoint);\r\n                ctx.beginPath();\r\n                // if(keypoint.part === 'leftElbow' || \r\n                //     keypoint.part === 'rightElbow' ||\r\n                //     keypoint.part === 'leftShoulder' ||\r\n                //     keypoint.part === 'rightShoulder') {\r\n                //     ctx.arc( keypoint.position.x, keypoint.position.y, 25, 0 * Math.PI / 180, 360 * Math.PI / 180, false ) ;\r\n                //     ctx.fillStyle = \"red\";\r\n                // }\r\n                ctx.arc( keypoint.position.x, keypoint.position.y, 10, 0 * Math.PI / 180, 360 * Math.PI / 180, false ) ;\r\n                ctx.fillStyle = \"red\";\r\n                ctx.fill() ;\r\n            }\r\n\r\n            setOpen(true);\r\n            const i = await loadImage(canvas.toDataURL());\r\n            // console.log(i);\r\n            setValue(i);\r\n\r\n            \r\n        }\r\n    }\r\n\r\n    async function readFileAsDataURL(file:File): Promise<string | ArrayBuffer | null> {\r\n        return new Promise((resolve, reject) => {\r\n            let fileReader = new FileReader();\r\n            fileReader.onload = (e) => resolve(fileReader.result);\r\n            fileReader.readAsDataURL(file);\r\n        });\r\n    }\r\n    return (\r\n        <div style={{textAlign: \"center\"}}>\r\n            <SelectLoadModelDialog \r\n                open={selectLoadModelDialogOpen}\r\n                setOpen={setSelectLoadModelDialogOpen}\r\n                values={selectLoadModelDialogValue}\r\n            />\r\n            <PoseNetPreview \r\n                id=\"ringtone-menu\"\r\n                keepMounted\r\n                open={open}\r\n                onClose={handlePoseNetPreviewClose}\r\n                value={value}\r\n            />\r\n            <p style={{fontSize:20,margin:\"5px 0px 0px 0px\"}}></p>\r\n            <div style={{padding:\"0px 10px 10px 10px\"}}>\r\n                <FormControl variant=\"filled\" className={classes.formControl}>\r\n                    <div>\r\n                        <Select\r\n                        style={{width:\"100%\"}}\r\n                        value={projectContext.activeModelIndex}\r\n                        onChange={onChangeModelSelect}\r\n                        native>\r\n                            {projectContext.models.map((model: ModelClass,index: number) => {\r\n                                return(\r\n                                <option key={index} value={index}>{model.modelName}</option>\r\n                            )})}\r\n                        </Select>\r\n                    </div>\r\n                    <div>\r\n                        <Button variant=\"contained\" style={{width:\"50%\"}} onClick={onLoadModel}></Button>\r\n                        <Button variant=\"contained\" style={{width:\"50%\"}} onClick={onDeleteModel}></Button>\r\n                    </div>\r\n                    {/* <>\r\n                        <Button variant=\"contained\" style={{width:\"100%\"}} onClick={setPosenet}>PoseNet</Button>\r\n                    </> */}\r\n                </FormControl>\r\n            </div>\r\n        </div>\r\n      );\r\n}\r\nexport default ModelControl;","import { Button, ButtonGroup, Grid } from '@material-ui/core';\r\nimport React, { useEffect, useState, useRef, CSSProperties } from 'react';\r\nimport BoneControl from './BoneControl';\r\nimport FaceControl from './FaceControl';\r\nimport ModelControl from './ModelControl';\r\n\r\ntype Props = {\r\n    controlMode: string,\r\n    setControlMode: React.Dispatch<React.SetStateAction<string>>,\r\n    isShowBoneSelect: boolean,\r\n    setIsShowBoneSelect: React.Dispatch<React.SetStateAction<boolean>>,\r\n}\r\nconst ModelControllers:React.VFC<Props> = props => {\r\n    return (\r\n        <>\r\n            <Grid item xs={4} style={{border: \"1px solid #ffffff\"}}>\r\n                <ModelControl key=\"modelcontrol\"  />\r\n            </Grid>\r\n            <Grid item xs={4} style={{border: \"1px solid #ffffff\"}}>\r\n                <BoneControl \r\n                    key=\"bonecontrol\"\r\n                    controlMode={props.controlMode}\r\n                    setControlMode={props.setControlMode} \r\n                    isShowBoneSelect={props.isShowBoneSelect}\r\n                    setIsShowBoneSelect={props.setIsShowBoneSelect}\r\n                />\r\n            </Grid>\r\n            <Grid item xs={4} style={{border: \"1px solid #ffffff\"}}>\r\n                <FaceControl key=\"faceControl\" />\r\n            </Grid>\r\n        </>\r\n    )\r\n}\r\nexport default ModelControllers;","import { Button, ButtonGroup, Grid, Input, makeStyles, Slider, Typography } from '@material-ui/core';\r\nimport React, { useEffect, useState, useRef, CSSProperties, useContext } from 'react';\r\nimport ProjectContext from '../contexts/ProjectContext';\r\n\r\ntype Props = {\r\n}\r\nconst useStyles = makeStyles({\r\n    root: {\r\n      width: 250,\r\n    },\r\n    input: {\r\n      width: 42,\r\n    },\r\n  });\r\n  \r\nconst CameraControl:React.VFC<Props> = props => {\r\n    const classes = useStyles();\r\n    const projectContext = useContext(ProjectContext);\r\n    const handleChange = (e:React.ChangeEvent<{}>,newValue:number | number[] ) => {\r\n        if (typeof newValue === 'number') {\r\n            console.log('newValue:' + newValue);\r\n            projectContext.setFov(newValue);\r\n        }\r\n    }\r\n    const handleInputChange = (event: React.ChangeEvent<HTMLInputElement>) => {\r\n        projectContext.setFov(Number(event.target.value));\r\n    };\r\n    const handleBlur = () => {\r\n        if (projectContext.fov < 0) {\r\n            projectContext.setFov(0);\r\n        } else if (projectContext.fov > 100) {\r\n            projectContext.setFov(100);\r\n        }\r\n      };\r\n    return (\r\n        <div style={{textAlign: \"center\", padding:\"5px\"}}>\r\n            <p style={{fontSize:20,margin:\"0px 0px 10px 0px\"}}></p>\r\n            <Typography id=\"input-slider\" gutterBottom>\r\n                \r\n            </Typography>\r\n            <Grid container spacing={2} alignItems=\"center\">\r\n                <Grid item xs>\r\n                    <Slider \r\n                        value={typeof projectContext.fov === 'number' ? projectContext.fov : 0}\r\n                        onChange={(e,newValue) => handleChange(e,newValue)}\r\n                        aria-labelledby=\"input-slider\"\r\n                        valueLabelDisplay=\"auto\"\r\n                        step={1}\r\n                        min={0}\r\n                        max={100}\r\n                    />\r\n                </Grid>\r\n                <Grid item>\r\n                    <Input\r\n                        className={classes.input}\r\n                        value={projectContext.fov}\r\n                        margin=\"dense\"\r\n                        onChange={handleInputChange}\r\n                        onBlur={handleBlur}\r\n                        inputProps={{\r\n                        step: 10,\r\n                        min: 0,\r\n                        max: 100,\r\n                        type: 'number',\r\n                        'aria-labelledby': 'input-slider',\r\n                        }}\r\n                    />\r\n                </Grid>\r\n            </Grid>\r\n\r\n        </div>\r\n    )\r\n}\r\nexport default CameraControl;","import { Button, ButtonGroup, Grid } from '@material-ui/core';\r\nimport React, { useEffect, useState, useRef, CSSProperties } from 'react';\r\nimport CameraControl from './CameraControl';\r\nimport LightControl from './LightControl';\r\n\r\ntype Props = {\r\n}\r\nconst CameraControllers:React.VFC<Props> = props => {\r\n    return (\r\n        <>\r\n            <Grid item xs={4} style={{border: \"1px solid #ffffff\"}}>\r\n                <CameraControl />\r\n            </Grid>\r\n        </>\r\n    )\r\n}\r\nexport default CameraControllers;","import React, { Suspense, useContext, useRef, useState } from 'react';\r\nimport * as p from '../package.json';\r\nimport './App.css';\r\nimport { AppBar, Button, createMuiTheme, createStyles, CssBaseline, Grid, IconButton, makeStyles, Menu, MenuItem, Theme, ThemeProvider, Toolbar, Typography } from '@material-ui/core';\r\nimport InfoIcon from '@material-ui/icons/Info';\r\nimport Brightness7Icon from \"@material-ui/icons/Brightness7\";\r\nimport Brightness4Icon from \"@material-ui/icons/Brightness4\";\r\nimport Box from '@material-ui/core/Box';\r\nimport ModelControl from './components/ModelControl';\r\nimport BoneControl from './components/BoneControl';\r\nimport FaceControl from './components/FaceControl';\r\nimport { ModelClass } from './classes/ModelClass';\r\nimport { MMDLoader } from './libs/MMDLoader';\r\nimport { MMDAnimationHelper } from 'three/examples/jsm/animation/MMDAnimationHelper';\r\nimport MainView from './components/MainView';\r\nimport StartDialog from './components/StartDialog';\r\nimport ProjectContext from './contexts/ProjectContext';\r\nimport ModelControllers from './components/ModelControllers';\r\nimport CameraControllers from './components/CameraControllers';\r\n\r\nconst useStyles = makeStyles((theme: Theme) =>\r\n  createStyles({\r\n    root: {\r\n      width: '100%',\r\n      maxWidth: 360,\r\n      backgroundColor: theme.palette.background.paper,\r\n    },\r\n    paper: {\r\n      width: '80%',\r\n      maxHeight: 435,\r\n    },\r\n  }),\r\n);\r\n\r\nfunction App() {\r\n    const [models, setModels] = useState<ModelClass[]>([]);\r\n    const [selectObject, setSelectObject] = useState(0);\r\n    const [activeModelIndex, setactiveModelIndex] = useState(-1);\r\n    const [controlMode, setControlMode] = useState('rotate');\r\n    const [editMode, setEditMode] = useState('model');\r\n    const [fov, setFov] = useState(50);\r\n    const [isShowBoneSelect, setIsShowBoneSelect] = useState(false);\r\n    const [anchorEl, setAnchorEl] = React.useState<null | HTMLElement>(null);\r\n    const [menuName, setMenuName] = React.useState(\"\");\r\n    const [darkMode, setDarkMode] = React.useState(\r\n        localStorage.getItem(\"darkMode\") === \"on\" ? true : false\r\n    );\r\n    const [dirHandle, setDirHandle] = useState();\r\n    const classes = useStyles();\r\n    const [open, setOpen] = React.useState(true);\r\n    const [value, setValue] = React.useState('Dione');\r\n\r\n    const handleStartDialogClose = (newValue?: string) => {\r\n        setOpen(false);\r\n    \r\n        if (newValue) {\r\n          setValue(newValue);\r\n        }\r\n      };\r\n    \r\n    const handleMenu = (event: React.MouseEvent<HTMLElement>, menuName:string) => {\r\n        setAnchorEl(event.currentTarget);\r\n        setMenuName(menuName);\r\n    };\r\n    \r\n    const handleClose = () => {\r\n        setAnchorEl(null);\r\n        setMenuName(\"\");\r\n    };\r\n\r\n    const handleDarkModeOn = () => {\r\n        localStorage.setItem(\"darkMode\", \"on\");\r\n        setDarkMode(true);\r\n    };\r\n    const handleDarkModeOff = () => {\r\n        localStorage.setItem(\"darkMode\", \"off\");\r\n        setDarkMode(false);\r\n    };\r\n    const theme = createMuiTheme({\r\n        palette: {\r\n            type: darkMode ? \"dark\" : \"light\",\r\n        },\r\n    });\r\n\r\n    const openPoseFile = async (e: any) => {\r\n        setAnchorEl(null);\r\n        setMenuName(\"\");\r\n        if(models.length === 0){\r\n            alert(\"\");\r\n            return;\r\n        }\r\n        let fileHandle;\r\n        const pickerOpts = {\r\n            types: [\r\n              {\r\n                description: 'MMD Pose Data',\r\n                accept: {\r\n                  '*/*': ['.vpd']\r\n                }\r\n              },\r\n            ],\r\n            excludeAcceptAllOption: true,\r\n            multiple: false\r\n        };\r\n        // @ts-ignore\r\n        [fileHandle] = await window.showOpenFilePicker(pickerOpts);\r\n        if(!fileHandle)return;\r\n        // @ts-ignore\r\n        var file = await fileHandle.getFile();\r\n        const loader = new MMDLoader();\r\n        const helper = new MMDAnimationHelper();\r\n        loader.loadVPDFromFile(file,(vpd) => {\r\n            const mesh = models[selectObject].mesh;\r\n            if(!mesh){\r\n                alert(\"\");\r\n                return;\r\n            }\r\n            helper.pose(mesh,vpd);\r\n        }, (progress) => {\r\n            console.log(progress);\r\n        }, (error) => {\r\n            console.log(error);\r\n        })\r\n    }\r\n    const openAbout = async (e: any) => {\r\n        const message = \"WebMMD\\n\\n\\n\\nGoogleChrome\\n\\nGithub\";\r\n        alert(message);\r\n    }\r\n\r\n    return (\r\n        <ThemeProvider theme={theme}>\r\n            <ProjectContext.Provider value={{\r\n                dirHandle,\r\n                setDirHandle,\r\n                models,\r\n                setModels,\r\n                activeModelIndex,\r\n                setactiveModelIndex,\r\n                editMode,\r\n                setEditMode,\r\n                fov,\r\n                setFov\r\n            }}>\r\n            <CssBaseline/>\r\n            <AppBar color=\"default\" position=\"static\">\r\n                <Toolbar variant=\"dense\">\r\n                    <Box display='flex' flexGrow={1}>\r\n                        <Typography variant=\"h6\">\r\n                            React MMD Viewer ver.{p.version}\r\n                        </Typography>\r\n                        <Button aria-controls=\"simple-menu\" aria-haspopup=\"true\" onClick={e => handleMenu(e,\"file\")}>\r\n                            File\r\n                        </Button>\r\n                        <Menu\r\n                            id=\"menu-appbar\"\r\n                            anchorEl={anchorEl}\r\n                            anchorOrigin={{\r\n                                vertical: 'top',\r\n                                horizontal: 'right',\r\n                            }}\r\n                            keepMounted\r\n                            transformOrigin={{\r\n                                vertical: 'top',\r\n                                horizontal: 'right',\r\n                            }}\r\n                            open={menuName === 'file' ? true : false}\r\n                            onClose={handleClose}\r\n                        >\r\n                            {/* <MenuItem onClick={saveProject}></MenuItem> */}\r\n                            <MenuItem onClick={openPoseFile}></MenuItem>\r\n                        </Menu>\r\n                    </Box>\r\n                    <IconButton\r\n                        aria-label=\"account of current user\"\r\n                        aria-controls=\"menu-appbar\"\r\n                        aria-haspopup=\"true\"\r\n                        onClick={e => handleMenu(e,\"info\")}\r\n                        color=\"inherit\"\r\n                    >\r\n                        <InfoIcon />\r\n                    </IconButton>\r\n                    <Menu\r\n                        id=\"menu-appbar\"\r\n                        anchorEl={anchorEl}\r\n                        anchorOrigin={{\r\n                            vertical: 'top',\r\n                            horizontal: 'right',\r\n                        }}\r\n                        keepMounted\r\n                        transformOrigin={{\r\n                            vertical: 'top',\r\n                            horizontal: 'right',\r\n                        }}\r\n                        open={menuName === 'info' ? true : false}\r\n                        onClose={handleClose}\r\n                    >\r\n                        <MenuItem onClick={openAbout}>About</MenuItem>\r\n                        <MenuItem onClick={() => window.open(\"https://github.com/\" + p.author.name + \"/\" + p.name)}>Github</MenuItem>\r\n                    </Menu>\r\n                    {darkMode ? (\r\n                        <IconButton color=\"inherit\" onClick={handleDarkModeOff}>\r\n                        <Brightness7Icon />\r\n                        </IconButton>\r\n                    ) : (\r\n                        <IconButton color=\"inherit\" onClick={handleDarkModeOn}>\r\n                        <Brightness4Icon />\r\n                        </IconButton>\r\n                    )}\r\n                </Toolbar>\r\n            </AppBar>\r\n            {/* <StartDialog\r\n                classes={{\r\n                    paper: classes.paper,\r\n                }}\r\n                id=\"ringtone-menu\"\r\n                keepMounted\r\n                open={open}\r\n                onClose={handleStartDialogClose}\r\n                value={value}\r\n            /> */}\r\n            <Grid container >\r\n                <Grid item xs={12} >\r\n                    <MainView \r\n                        selectObject={selectObject}\r\n                        controlMode={controlMode}\r\n                        isShowBoneSelect={isShowBoneSelect}\r\n                    />\r\n                </Grid>\r\n                {editMode === 'model' ? (\r\n                    <ModelControllers \r\n                        controlMode={controlMode}\r\n                        setControlMode={setControlMode} \r\n                        isShowBoneSelect={isShowBoneSelect}\r\n                        setIsShowBoneSelect={setIsShowBoneSelect}\r\n                    />\r\n                ) : (\r\n                    <CameraControllers />\r\n                )}\r\n            </Grid>\r\n            </ProjectContext.Provider>\r\n        </ThemeProvider>\r\n    );\r\n}\r\n\r\nexport default App;\r\n","import { ReportHandler } from 'web-vitals';\n\nconst reportWebVitals = (onPerfEntry?: ReportHandler) => {\n  if (onPerfEntry && onPerfEntry instanceof Function) {\n    import('web-vitals').then(({ getCLS, getFID, getFCP, getLCP, getTTFB }) => {\n      getCLS(onPerfEntry);\n      getFID(onPerfEntry);\n      getFCP(onPerfEntry);\n      getLCP(onPerfEntry);\n      getTTFB(onPerfEntry);\n    });\n  }\n};\n\nexport default reportWebVitals;\n","import React from 'react';\nimport ReactDOM from 'react-dom';\nimport './index.css';\nimport App from './App';\nimport reportWebVitals from './reportWebVitals';\n\nReactDOM.render(\n  <React.StrictMode>\n    <App />\n  </React.StrictMode>,\n  document.getElementById('root')\n);\n\n// If you want to start measuring performance in your app, pass a function\n// to log results (for example: reportWebVitals(console.log))\n// or send to an analytics endpoint. Learn more: https://bit.ly/CRA-vitals\nreportWebVitals();\n"],"sourceRoot":""}